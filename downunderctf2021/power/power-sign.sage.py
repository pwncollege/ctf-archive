

#!/usr/bin/exec-suid -- /usr/bin/python3
# This file was *autogenerated* from the file power-sign.sage
from sage.all_cmdline import *   # import sage library

_sage_const_2 = Integer(2); _sage_const_1 = Integer(1); _sage_const_4 = Integer(4); _sage_const_3 = Integer(3); _sage_const_0 = Integer(0); _sage_const_1024 = Integer(1024); _sage_const_15 = Integer(15); _sage_const_16 = Integer(16); _sage_const_5 = Integer(5)#!/usr/bin/env sage

proof.arithmetic(False) # just makes things faster

def get_3m4_prime(N):
    while True:
        p = random_prime(_sage_const_2 **N - _sage_const_1 , lbound=_sage_const_2 **(N-_sage_const_1 ))
        if p % _sage_const_4  == _sage_const_3 :
            return p

def generate_key(L, n, m):
    p = get_3m4_prime(L//_sage_const_2 )
    q = get_3m4_prime(L//_sage_const_2 )
    N = p*q
    r = next_prime(N)
    F = PolynomialRing(GF(r), names=('x',)); (x,) = F._first_ngens(1)
    K = F.quo(F.irreducible_element(n))
    return (K, m), N, (p, q)

def H(params, msg, u):
    K, m = params
    r, z = K.characteristic(), K.gens()[_sage_const_0 ]
    h = _sage_const_0 
    while msg > _sage_const_0 :
        h *= z
        h += msg % r
        msg //= r
    h += z*u
    for _ in range(m):
        h **= r
    assert len(list(h)) != _sage_const_0 
    return int(h[_sage_const_0 ])

def sign(params, privkey, msg):
    p, q = privkey
    u = _sage_const_1 
    while True:
        c = H(params, msg, u) % (p*q)
        if legendre_symbol(c, p) == legendre_symbol(c, q) == _sage_const_1 :
            break
        u += _sage_const_1 
    xp = pow(c, (p+_sage_const_1 )//_sage_const_4 , p)
    xq = pow(c, (q+_sage_const_1 )//_sage_const_4 , q)
    x = crt([int(xp), int(xq)], [p, q])
    return x, u

def verify(params, pubkey, msg, sig):
    N = pubkey
    x, u = sig
    c = H(params, msg, u)
    return x**_sage_const_2  % N == c % N

def main():
    print('Welcome to the game. To get the flag, give me a message to sign, then sign a random message of mine!')
    FLAG = open('/flag', 'r').read().strip()

    L, n, m = _sage_const_1024 , _sage_const_15 , _sage_const_3 
    params, pubkey, privkey = generate_key(L, n, m)
    print('N:', pubkey)

    msg = int(input('message (in hex): '), _sage_const_16 )
    if msg < pubkey**m:
        print('That message is too small!')
        exit()
    if msg > pubkey**n:
        print('That message is too big!')
        exit()
    x, u = sign(params, privkey, msg)
    print('x:', x)
    print('u:', u)

    auth_msg = randint(_sage_const_1 , pubkey**_sage_const_5 )
    print('Now sign', hex(auth_msg))
    x = int(input('x: '))
    u = int(input('u: '))

    if verify(params, pubkey, auth_msg, (x, u)):
        print(FLAG)
    else:
        print('Incorrect!')

if __name__ == '__main__':
    main()

