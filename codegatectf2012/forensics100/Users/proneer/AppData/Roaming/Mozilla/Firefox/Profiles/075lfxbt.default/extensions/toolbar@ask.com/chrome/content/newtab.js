/*
 * Copyright (C) 2008-2010 APN, LLC. All rights reserved
 * 
 * Author: Michael Mayfield
 * Description: Controller for newtab.html
 */
var NewTab;if(!NewTab){NewTab={}}window.addEventListener("load",function(){NewTab.mainWindow=window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).getInterface(Components.interfaces.nsIWebNavigation).QueryInterface(Components.interfaces.nsIDocShellTreeItem).rootTreeItem.QueryInterface(Components.interfaces.nsIInterfaceRequestor).getInterface(Components.interfaces.nsIDOMWindow);NewTab.v=new NewTab.View(new NewTab.Controller())},false);NewTab.mainWindow=null;NewTab.v=null;NewTab.TITLE_ID="title";NewTab.HISTORY_ID="history";NewTab.HISTORY_TITLE_ID="history-title";NewTab.HISTORY_MORE_LINK_ID="more-link";NewTab.WEATHER_TITLE_ID="weather-title";NewTab.SEARCH_FORM_ID="search-form";NewTab.SEARCH_INPUT_ID="search-input";NewTab.LOCATIONS_ID="locations";NewTab.WEATHER_FORM_ID="weather-form";NewTab.ZIP_INPUT_ID="zip-input";NewTab.ZIP_INPUT_LABEL_ID="zip-input-label";NewTab.TAGLINE_ID="tagline";NewTab.DISABLE_LINK_ID="disable-link";NewTab.FOOTER_ID="footer";NewTab.FOOTER_TITLE_ID="footer-title";NewTab.TITLE_KEY="NewTabsTitle";NewTab.FOOTER_TITLE_KEY="NewTabsFooterTitle";NewTab.HISTORY_TITLE_KEY="NewTabsHistoryTitle";NewTab.WEATHER_TITLE_KEY="NewTabsWeatherTitle";NewTab.ZIP_INPUT_LABEL_KEY="NewTabsZipInputLabel";NewTab.TAGLINE_KEY="NewTabsTagLine";NewTab.DISABLE_LINK_KEY="NewTabsDisableLink";NewTab.CONFIRM_DISABLE_MSG_KEY="NewTabsDisableMsg";NewTab.CONFIRM_DISABLE_TITLE_KEY="NewTabsDisableTitle";NewTab.ASK_NEW_TAB_SEARCH_MACRO="$AskNewTabSearchResults$";NewTab.ASK_NEW_TAB_WEATHER_SEARCH_MACRO="$AskNewTabWeatherSearch$";NewTab.HIDDEN_CLASS="hidden";NewTab.DISABLED_CLASS="disabled";NewTab.FOCUS_CLASS="focus";NewTab.get=function(a){return document.getElementById(a)};NewTab.getString=function(a){return NewTab.mainWindow.ATB.Utils.getLocalizedStringForKey(a)};NewTab.Controller=function(){};NewTab.Controller.prototype.getLocationHistory=function(a){a=parseInt(a);if(!a||a<1){a=NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_HISTORY_ITEMS}var c={};function b(h){var g=h.url.substr(0,8);var d=(g=="https://")||(g.substr(0,7)=="http://");var e=d?h.url.substr(0,h.url.indexOf("/",8)):h.url;var f=e+"/"+h.title;if(f in c){return false}c[f]=true;return true}return NewTab.mainWindow.ATB.Utils.getFrequentNavigationHistory(a,b)};NewTab.Controller.prototype.performWebSearch=function(a){if(a!=NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_INPUT_TEXT){NewTab.mainWindow.ATB.Core.setUserQuery(a)}else{NewTab.mainWindow.ATB.Core.setUserQuery("")}NewTab.mainWindow.ATB.Core.searchAction(null,NewTab.get(NewTab.SEARCH_INPUT_ID),NewTab.ASK_NEW_TAB_SEARCH_MACRO,false,false)};NewTab.Controller.prototype.performWeatherSearch=function(a){NewTab.mainWindow.ATB.Core.setUserQuery(a);NewTab.mainWindow.ATB.Core.searchAction(null,NewTab.get(NewTab.ZIP_INPUT_ID),NewTab.ASK_NEW_TAB_WEATHER_SEARCH_MACRO,false,false)};NewTab.Controller.prototype.disableNewTabs=function(){NewTab.mainWindow.ATB.Prefs.setNewTabEnabled(false);NewTab.mainWindow.ATB.Prefs.setNewTabOptOut(true);NewTab.mainWindow.ATB.NewTab.disableNewTabUrlProcessing();var a=NewTab.mainWindow;a.gBrowser.removeCurrentTab();a.ATB.NewTab.onNewTab()};NewTab.View=function(a){var c,b=this;this._controller=a;this._populateLocations(this._controller.getLocationHistory());c=NewTab.get(NewTab.SEARCH_INPUT_ID);if(NewTab.mainWindow.gURLBar){NewTab.mainWindow.gURLBar.focus()}this._setLocalizedContent();this._recalculateFooter();window.addEventListener("resize",function(d){b._recalculateFooter()},false);c.addEventListener("focus",function(d){b._handleSearchInputFocusClickKeypress(d)},false);c.addEventListener("click",function(d){b._handleSearchInputFocusClickKeypress(d)},false);c.addEventListener("keypress",function(d){b._handleSearchInputFocusClickKeypress(d)},false);c.addEventListener("blur",function(d){b._handleSearchInputBlur(d)},false);c=NewTab.get(NewTab.SEARCH_FORM_ID);c.addEventListener("submit",function(d){b._handleSearchFormSubmit(d)},false);c=NewTab.get(NewTab.WEATHER_FORM_ID);c.addEventListener("submit",function(d){b._handleWeatherFormSubmit(d)},false);c=NewTab.get(NewTab.DISABLE_LINK_ID);c.addEventListener("click",function(d){b._handleDisableLinkClick(d)},false);c=NewTab.get(NewTab.HISTORY_MORE_LINK_ID);c.addEventListener("click",function(d){b._handleMoreLinkClick(d)},false)};NewTab.View.prototype._setLocalizedContent=function(){var a;a=NewTab.get(NewTab.TITLE_ID);a.innerHTML=NewTab.getString(NewTab.TITLE_KEY);a=NewTab.get(NewTab.HISTORY_TITLE_ID);a.innerHTML=NewTab.getString(NewTab.HISTORY_TITLE_KEY);a=NewTab.get(NewTab.WEATHER_TITLE_ID);a.innerHTML=NewTab.getString(NewTab.WEATHER_TITLE_KEY);a=NewTab.get(NewTab.ZIP_INPUT_LABEL_ID);a.innerHTML=NewTab.getString(NewTab.ZIP_INPUT_LABEL_KEY);a=NewTab.get(NewTab.SEARCH_INPUT_ID);a.value=NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_INPUT_TEXT;a=NewTab.get(NewTab.TAGLINE_ID);a.innerHTML=NewTab.getString(NewTab.TAGLINE_KEY);a=NewTab.get(NewTab.DISABLE_LINK_ID);a.innerHTML=NewTab.getString(NewTab.DISABLE_LINK_KEY);a=NewTab.get(NewTab.FOOTER_TITLE_ID);a.innerHTML=NewTab.getString(NewTab.FOOTER_TITLE_KEY)};NewTab.View.prototype._populateLocations=function(e){var b,a=[],d;b=NewTab.get(NewTab.LOCATIONS_ID);d=NewTab.get(NewTab.HISTORY_MORE_LINK_ID);for(var c=0;c<e.length;c++){a.push("<div class='location'>");a.push(this._getLocationMarkup(e[c]));a.push("</div>")}b.innerHTML=a.join("");if(e.length==0){d.setAttribute("class",NewTab.HIDDEN_CLASS)}else{if(e.length<NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_HISTORY_ITEMS){d.setAttribute("class",NewTab.HIDDEN_CLASS)}else{d.removeAttribute("class")}}};NewTab.View.prototype._controller=null;NewTab.View.prototype._handleSearchInputFocusClickKeypress=function(b){var a=NewTab.get(NewTab.SEARCH_INPUT_ID);if(a.value==NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_INPUT_TEXT){a.value=""}a.setAttribute("class",NewTab.FOCUS_CLASS)};NewTab.View.prototype._handleSearchInputBlur=function(b){var a=NewTab.get(NewTab.SEARCH_INPUT_ID);if(a.value==""&&a.value!=NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_INPUT_TEXT){a.value=NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_DEFAULT_INPUT_TEXT;a.removeAttribute("class")}};NewTab.View.prototype._handleSearchFormSubmit=function(b){var a=NewTab.get(NewTab.SEARCH_INPUT_ID);this._controller.performWebSearch(a.value);b.preventDefault();b.stopPropagation()};NewTab.View.prototype._handleWeatherFormSubmit=function(b){var a=NewTab.get(NewTab.ZIP_INPUT_ID);this._controller.performWeatherSearch(a.value);b.preventDefault();b.stopPropagation()};NewTab.View.prototype._handleDisableLinkClick=function(c){var a=Components.classes["@mozilla.org/embedcomp/prompt-service;1"].getService(Components.interfaces.nsIPromptService);var f=NewTab.getString(NewTab.CONFIRM_DISABLE_MSG_KEY);var d=NewTab.getString(NewTab.CONFIRM_DISABLE_TITLE_KEY);var b=a.confirm(null,d,f);if(b){this._controller.disableNewTabs()}};NewTab.View.prototype._handleMoreLinkClick=function(c){var b=NewTab.get(NewTab.HISTORY_MORE_LINK_ID);if(b.hasAttribute("class")&&b.getAttribute("class")==NewTab.DISABLED_CLASS){return false}this._populateLocations(this._controller.getLocationHistory(NewTab.mainWindow.ATB.Constants.ATB_NEWTAB_MORE_HISTORY_ITEMS));b.setAttribute("class",NewTab.HIDDEN_CLASS);var a=this;setTimeout(function(){a._recalculateFooter()},1)};NewTab.View.prototype._recalculateFooter=function(){var a=NewTab.get(NewTab.FOOTER_ID);var c=NewTab.get(NewTab.HISTORY_ID);var b=window.getComputedStyle(a,null);var d=parseInt(b.top);var e=parseInt(b.bottom);b=window.getComputedStyle(c,null);var f=parseInt(b.height)+c.offsetTop;if(d!=NaN&&e!=NaN&&f!=NaN){if(d<=f&&!a.hasAttribute("style")){a.setAttribute("style","top: "+f+"px;")}else{if(e>0&&a.hasAttribute("style")){a.removeAttribute("style")}}}};NewTab.View.prototype._getLocationMarkup=function(b){var a=["<img class='location-icon' src='"];a.push(b.icon);a.push("' /><a class='location-link' href='");a.push(b.url);a.push("'>");a.push(b.title);a.push("</a>");return a.join("")};