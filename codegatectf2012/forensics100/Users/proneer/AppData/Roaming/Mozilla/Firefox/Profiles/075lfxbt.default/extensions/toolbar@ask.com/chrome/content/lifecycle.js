/*
 * Copyright (C) 2008-2010 APN, LLC. All rights reserved
 * References to external sources embedded in the code.
 * 
 * Author: Vishal V. Shah
 * Description: Toolbar lifecycle logic.
 */
var ATB={Cache:null,Suggestions:null,Widgets:null,Feeds:null,Events:null,Net:null,Observer:null,ExtnMgrListener:null,Utils:null,Core:null,Prefs:null,Logger:null,Locale:null,LifeCycle:null,Constants:null,Defaults:null,Update:null,Prefetch:null,DynamicButtonManager:null,NewTab:null,WebFrameManager:null,Notifications:null};function ATB_load(b){var d=false;try{ATB.Constants=new ATB_Constants();ATB.Defaults=new ATB_Defaults();ATB.Logger=new ATB_Logger();ATB.Observer=new ATB_Observer();try{ATB.Logger.warn("Start *ATB TOOLBAR* Init... (",navigator.userAgent,")");ATB.Observer.publish(ATB.Observer.Events.INIT_START)}catch(a){ATB.Logger.error("Error occured while publishing event (ATB.Observer.Events.INIT_START): ",a)}ATB.Observer.publish(ATB.Observer.Events.CORE_MODULES_LOADED);ATB.Utils=new ATB_Utilities();ATB.Prefs=new ATB_Preferences();ATB.Net=new ATB_Network();ATB.Core=new ATB_Core();ATB.Locale=new ATB_Locale();if(ATB.Utils.getBrowserVersion()>=3){ATB.Cache=new ATB_Cache()}ATB.HTTPHeaders=new ATB_HTTP_Headers();ATB.Update=new ATB_Update(b);if(ATB.Utils.isFirefoxShuttingDown()){try{ATB.Logger.warn("Aborting *ATB TOOLBAR* Init due to FF restart.")}catch(c){}return}ATB.LifeCycle=new ATB_LifeCycle(b);ATB.Events=new ATB_Events();ATB.Widgets=new ATB_Widgets();ATB.Prefetch=new ATB_Prefetch();ATB.Feeds=new ATB_Feeds();ATB.ExtnMgrListener=new ATB_ExtnMgrListener();ATB.Suggestions=new ATB_Suggestions();ATB.DynamicButtonManager=new ATB_DynamicButtonManager();if(typeof(ATB_NewTab)=="function"){ATB.NewTab=new ATB_NewTab()}if(typeof(ATB_WebFrameManager)=="function"){ATB.WebFrameManager=new ATB_WebFrameManager()}if(typeof(ATB_Notifications)=="function"&&ATB.Utils.getBrowserVersion()>=3){ATB.Notifications=new ATB_Notifications()}ATB.Observer.publish(ATB.Observer.Events.ALL_MODULES_LOADED);ATB_postload();d=true}catch(a){d=false;ATB.Logger.error("Error occured while initializing toolbar (ATB.Lifecycle)..: ",a)}finally{ATB.Logger.warn("End *ATB TOOLBAR* Init...");if(d){ATB.Logger.info("*ATB TOOLBAR* Initialized successfully")}ATB.Observer.publish(ATB.Observer.Events.INIT_COMPLETE,{success:d})}}function ATB_postload(){try{ATB.Logger.warn("Toolbar load complete, creating timers for existing cache entries...");if(ATB.Cache){ATB.Cache.createTimersForExistingEntries()}if(ATB.Prefs.getFirstRestartAfterConfigUpdate()===true&&ATB.Update.isFirstFirefoxLaunchAfterInstallorUpgrade!=true){try{if(ATB.Utils.getBrowserVersion()>=3.5){var b=ATB.Utils.getProfileDirectory();if(b&&b.path.length>0){ATB.Logger.info("Using profileDir path: ",b.path);b.append("search.json");var d=b;ATB.Logger.info("Deleting searchJsonFile path: ",d.path);d.remove(false);ATB.Logger.info("Deleted search.json file from profiles folder")}else{ATB.Logger.error("Could not find profile directory/folder")}}}catch(c){ATB.Logger.error("Unable to delete search.json file from profile folder, error:",c)}ATB.Logger.warn("Setting the first-restart-after-config-update flag in preferences to false(since this was the first restart)");ATB.Prefs.setFirstRestartAfterConfigUpdate(false)}if(ATB.Prefs.getBoolPref(ATB.Constants.ATB_ADD_BAR_WAR_ENABLED)&&ATB.Prefs.isSAEnabled()){window.setTimeout(ATB.Core.updateKeywordUrlIfTakeover,1500);window.setTimeout(ATB.Core.updateKeywordUrlIfTakeover,3000);window.setTimeout(ATB.Core.updateKeywordUrlIfTakeover,5000)}}catch(a){ATB.Logger.error("Error occured during postload (while creating timers, etc) ..: ",a)}}function ATB_unload(b){ATB.Logger.info("ATB.LifeCycle: Unloading ATB Toolbar.");ATB.Observer.publish(ATB.Observer.Events.UNLOAD_START);try{if(ATB.WebFrameManager){ATB.WebFrameManager.unload(b)}if(ATB.DynamicButtonManager!==null){ATB.DynamicButtonManager.unload(b)}if(ATB.Events!==null){ATB.Events.unload(b)}if(ATB.Prefs!==null){ATB.Prefs.unload(b)}if(ATB.Core!==null){ATB.Core.unload()}if(ATB.Feeds!==null){ATB.Feeds.unload()}if(ZoomManager&&ZoomManager.prototype){ZoomManager.prototype.getInstance().reset();if(ATB.Core!==null){ATB.Core.zoom(100)}}if(ATB.ExtnMgrListener!==null){ATB.ExtnMgrListener.unregister()}}catch(a){ATB.Logger.error("Error occured ATB.LifeCycle#unload phase: ",a)}finally{if(ATB.Core.isMasterToolbar()){ATB.Logger.info("ATB.LifeCycle: unload: ATB master window is being closed. Assign another open window as the master (if any)..");ATB.LifeCycle.masterWindow.isATBMaster=undefined;ATB.LifeCycle.masterWindow=null;ATB.LifeCycle.updateMasterWindowRef(window);ATB.Logger.info("ATB.LifeCycle: unload: New ATB master window: ",this.masterWindow)}if((!ATB.LifeCycle||(ATB.LifeCycle&&!ATB.LifeCycle.masterWindow))&&ATB.Prefs.getBoolPref(ATB.Constants.ATB_CONFIG_UPDATE_FLAG)){ATB.Logger.info("ATB.LifeCycle: unload: All windows are closing + New config was downloaded so clearing cache, etc.");if(ATB.Cache!==null){ATB.Cache.removeAll()}else{ATB.Logger.info("No ATB.Cache object found")}ATB.Prefs.setBoolPref(ATB.Constants.ATB_CONFIG_UPDATE_FLAG,false);ATB.Logger.info("ATB.LifeCycle: unload: DONE clearing cache, etc.")}ATB.HTTPHeaders.detach();if(ATB.Cache!==null){ATB.Cache.unload()}ATB.Logger.destruct();ATB.Logger.info("ATB.LifeCycle: unload complete.")}return}var ATB_LifeCycle=function(a){this.masterWindow=null;this.init(a)};ATB_LifeCycle.prototype={init:function(a){ATB.Logger.info("Start *LifeCycle* Init...");this.updateMasterWindowRef();if(ATB.Prefs.isFirstLaunch()&&!ATB.Utils.isFirefoxShuttingDown()){this.performFirstLaunchProcessing(a)}this.performFirefoxVersionSpecificProcessing();ATB.Logger.info("End *LifeCycle* Init...")},updateMasterWindowRef:function(b){var d=ATB.Utils.getAllBrowserWindows();var a=null;var c=null;while(d.hasMoreElements()){c=d.getNext();if(c&&(!a)&&(!c.dying)&&(typeof(b)=="undefined"||((typeof(b)!="undefined"&&c!=b)))){ATB.Logger.debug("Setting firstCycledWindow as: ",c);a=c}if(typeof(c.isATBMaster)!="undefined"&&c.isATBMaster&&!c.dying){ATB.Logger.info("Identified the current ATB master window: ",c);this.setMasterWindow(c,true);break}}if(!this.masterWindow){if(a){ATB.Logger.info("Setting ATB master window to: ",a);this.setMasterWindow(a,true)}else{ATB.Logger.info("All browser windows are being closed since no candidates available to become a master window.")}}ATB.Logger.info("ATB master window: ",this.masterWindow)},markMasterAsDying:function(){this.getMasterWindow().dying=true},getMasterWindow:function(){return this.masterWindow},setMasterWindow:function(b,c){if(b){ATB.Logger.debug("setMasterWindow: Setting master window reference to: ",b,", title: ",b.title);this.masterWindow=b;this.masterWindow.isATBMaster=true;if(b!=window){window.isATBMaster=false}if(typeof(c)!="undefined"&&c){var d=ATB.Utils.getAllBrowserWindows();var a=null;while(d.hasMoreElements()){a=d.getNext();if(a==window){continue}if(a&&a.ATB&&a.ATB.LifeCycle){ATB.Logger.debug("Setting master window reference for window: ",a);a.ATB.LifeCycle.setMasterWindow(b,false)}else{ATB.Logger.warn("Failed to set master window:  ATB.LifeCycle hasn't initialized yet, for window: "+a)}}}}else{ATB.Logger.error("Cannot update master window since the passed in windowObj is not a valid window object: ",b)}if(window.isATBMaster){ATB.HTTPHeaders.attach()}else{ATB.HTTPHeaders.detach()}},performFirstLaunchProcessing:function(b){ATB.Logger.info("First launch after inital config update detected. Processing... Setting first-launch to false.");ATB.Prefs.setFirstLaunch(false);var d="";try{d=ATB.Prefs.getFirstLaunchUrl();ATB.Logger.info("Pulled firstLaunchUrl from the preference system: ",d);if(!ATB.Prefs.macroReplaced(d)){d="";ATB.Logger.info('firstLaunchUrl will be reset to "',ATB.Utils.getFirefoxDefaultHomePage(),'" since its macro was not replaced.')}if(d==null||ATB.Utils.trim(d).length==0){var e=ATB.Utils.getBrowserHomePage();if(e.indexOf("resource:")!=0&&e.indexOf("chrome:")!=0){if(e.indexOf("http")==-1){e="http://"+e}d=e}else{ATB.Logger.info("firstLaunchUrl is either a resource: or chrome: url or references browser.jar: ",e,". Using the default/firefox home page...");d=ATB.Utils.getFirefoxDefaultHomePageUsingBrowserProperties()}}}catch(a){ATB.Logger.error("Error caluclating the home page url. Error: ",a);d=""}if(!d||ATB.Utils.trim(d).length==0){d=ATB.Utils.getFirefoxDefaultHomePage();ATB.Logger.info('firstLaunchUrl was reset to "',ATB.Utils.getFirefoxDefaultHomePage(),'"')}var c=document.getElementById("asktb");if(c&&c.collapsed){ATB.Logger.info("Toolbar was collapsed (probably by previous user action on View > Toolbars). Uncollapsing it.");c.collapsed=false}else{if(c){ATB.Logger.debug("Toolbar was NOT collapsed (by previous user action on View > Toolbars). That's nice.")}}ATB.Logger.info("Forwarding to firstLaunchUrl: ",d);ATB.Core.navigateToUrl(b,d)},performFirefoxVersionSpecificProcessing:function(){try{ATB.Logger.info("Performing browser version specific processing...");var b=ATB.Utils.getBrowserVersion();if(b<2){ATB.Logger.info("** Firefox version less than 2.0 detected. All menu-buttons will be disabled");var f=document.getElementsByTagName("toolbarbutton");if(f){var d=null;for(var c=0;c<f.length;++c){d=f.item(c);if(d!=null&&d.getAttribute("type")=="menu-button"){ATB.Logger.info("Changing the type of button (",d.getAttribute("id"),") from menu-button to menu, due to Firefox 1.5 limitations..");d.setAttribute("type","menu")}}}document.getElementById("asktb-options-menu-ch").style.display="none"}else{if(b<3){var e=document.getElementById("asktb-splitter");if(e){e.style.marginLeft="-3px"}document.getElementById("asktb-options-menu-ch").style.display="none"}}ATB.Logger.info("Done performing browser version specific processing.")}catch(a){ATB.Logger.error("performFirefoxVersionSpecificProcessing error: ",a)}return}};