/*
 * Copyright (C) 2008-2010 APN, LLC. All rights reserved
 * 
 * References to external sources embedded in the code.
 * 
 * Author: Vishal V. Shah Description: Toolbar utilities.
 */
var ATB_Utilities=function(){this.MACROS_REG_LOC_IE7_AND_ABOVE="Software\\AppDataLow\\Software\\AskSuperBar\\Macro";this.COBRANDID_MACRO="cbid";this.BAR_AFFILIATE_MACRO="o";this.QSRC_MACRO="qsrc";this.LOCALE_MACRO="locale";this.LOCATION_MACRO="location";this.DISTYPE_MACRO="l";this.TRACKID_MACRO="dtid";this.OVER_INSTALL_MACRO="oi";this.shuttingDown=false;this.PREFS_SERVICE=Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService);this.PREFS_BRANCH=this.PREFS_SERVICE.getBranch(ATB.Constants.ATB_EXT_PREFS_BRANCH)};ATB_Utilities.getExtensionDirectoryFromFile=function(c){var d=null;var a=ATB_Utilities.getLocalFileContentsAsLinesArray(c);if(a&&a.length>0){var b=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);b.initWithPath(a[0]);if(b&&b.exists()&&b.isDirectory()){d=b}}return d};ATB_Utilities.getProfileDirectory=function(){return Components.classes["@mozilla.org/file/directory_service;1"].getService(Components.interfaces.nsIProperties).get("ProfD",Components.interfaces.nsIFile)};ATB_Utilities.getLocalFileContentsAsLinesArray=function(d){var b=new Array();if(d){var e=Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);try{e.init(d,1,292,0);e.QueryInterface(Components.interfaces.nsILineInputStream);var a={},c;do{c=e.readLine(a);b.push(a.value)}while(c)}finally{e.close()}}return b};ATB_Utilities.prototype={getBrowserHomePage:function(){return ATB.Prefs.getHomePagePref()},getFirefoxDefaultHomePage:function(){return"http://www.google.com/firefox"},getFirefoxDefaultHomePageUsingBrowserProperties:function(){var a="";ATB.Logger.info("browser.startup.homepage starts with a resource: or a chrome:. Hence using browserconfig.properties to detect browser hp..");var c=Components.classes["@mozilla.org/file/directory_service;1"].getService(Components.interfaces.nsIProperties).get("CurProcD",Components.interfaces.nsIFile);if(c&&c.path.length>0){c.append("browserconfig.properties");var h=c;if(h.exists()){var g=h.path;ATB.Logger.debug("Identified browserconfig.properties: ",g);var h=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);ATB.Logger.debug("Initializing browserConfigPropsFile (nsILocalFile): ",h," with the path: ",g);h.initWithPath(g);ATB.Logger.debug("Got a handle on browserconfig.properties file: ",h.path);var b=ATB_Utilities.getLocalFileContentsAsLinesArray(h);ATB.Logger.debug("Read browserconfig.properties file: ",b,". Looping through the entries to find browser.startup.homepage...");for(var e=0;e<b.length;e++){ATB.Logger.debug("Read line: ",b[e]);if(b[e]&&b[e].length>0){var f=b[e].indexOf("browser.startup.homepage");if(f==0){var d=b[e].substring(b[e].indexOf("=")+1);if(d&&d.length>0){ATB.Logger.debug("Parsed ff default home page url as: ",d);a=d;break}}}}}else{ATB.Logger.warn('<ff-install-dir>/browserconfig.properties file does NOT exist. Using "" as the first launch url..');a=""}}return a},getBrowserVersion:function(){var a=Components.classes["@mozilla.org/xre/app-info;1"].getService(Components.interfaces.nsIXULAppInfo);return parseFloat(a.version)},getBrowserLanguage:function(){return ATB.Prefs.getCharPref("useragent.locale",ATB.Prefs.getGeneralPrefsBranch())},isWindowsOS:function(){var d=true;var c=navigator.userAgent;if(c&&c.length>0){var b=c.match(/^.*Windows.*$/);if(b){var a=b[0];if(!a||a.length==0){d=false}}}return d},jsonEval:function(a){try{return JSON.parse(a)}catch(b){ATB.Logger.error("Error eval'ing on JSON str (escaped): ",window.escape(a)," - JSON format might not be valid. Error: ",b);return{}}},jsonStringify:function(b){try{return JSON.stringify(b)}catch(a){ATB.Logger.error("Error stringifying an object. Error: ",a);return""}},getFrequentNavigationHistory:function(d,c){if(typeof d=="undefined"){d=10}var e=[];var j=Components.classes["@mozilla.org/browser/nav-history-service;1"].getService(Components.interfaces.nsINavHistoryService);var p=j.getNewQuery();var r=j.getNewQueryOptions();r.sortingMode=r.SORT_BY_VISITCOUNT_DESCENDING;if(r.redirectsMode!==undefined){r.redirectsMode=r.REDIRECTS_MODE_TARGET}var m=0,o,g;do{g=[];o=m;r.maxResults=o+Math.max(d,10)*3;var q=j.executeQuery(p,r);q.root.containerOpen=true;m=q.root.childCount;var f=null,b=null,a=null;var k,h,l;for(l=m-1;l>=o;l--){f=q.root.getChild(l);if(f.uri instanceof Components.interfaces.nsIURI){b=f.uri.spec}else{b=f.uri}if(f.icon instanceof Components.interfaces.nsIURI){a=f.icon.spec}else{a=f.icon}if(!a||a==""){a=ATB.Constants.ATB_DEFAULT_LOCATION_FAVICON}var k={title:f.title,url:b,icon:a};if(c&&!c(k)){continue}g.push(k);if(e.length+g.length==d){break}}e=e.concat(g)}while((g.length>0)&&(e.length<d));q.root.containerOpen=false;return e.reverse()},getMacrosRegLocation:function(){var a=ATB.Prefs.getTbMacrosRegLocation();if(a==null||a.length==0){ATB.Logger.error("Could not retrieve the macro registry location from the preference system. It must not have been set by the installer or for some other reason is currently empty. Defaulting to using: ",this.MACROS_REG_LOC_IE7_AND_ABOVE);a=this.MACROS_REG_LOC_IE7_AND_ABOVE}ATB.Logger.debug("Identified macrosRegLocation: ",a);return a},getUpdateRegLocation:function(){var a=ATB.Prefs.getCharPref(ATB.Constants.ATB_UPDATE_REG_LOCATION_PREF);if(a==""){ATB.Logger.error("getUpdateRegLocation : The value for updateRegLocation in prefs is empty. This might cause silent upgrade to fail")}return a},getRegKeyService:function(){try{return Components.classes["@mozilla.org/windows-registry-key;1"].createInstance(Components.interfaces.nsIWindowsRegKey);ATB.Logger.info("Using registry key service: ",regKeyService)}catch(a){ATB.Logger.error("Could not retrieve the windows registry key service - ",a);return null}return null},getRegistryEntry:function(e,a,d,c){ATB.Logger.debug('Fetching registry entry: "',e,'" from: ',a,". rootKey: ",c);var f="";if(this.isWindowsOS()){var g=this.getRegKeyService();if(g){if(typeof(a)=="undefined"||a==null||a.length==0){ATB.Logger.error("regPathUnderRoot is not specified or empty. Using: ",a)}else{try{if(typeof(c)=="undefined"||c==null){ATB.Logger.debug("rootKey is null! Opening regKeyService using rootKey HKEY_CURRENT_USER");g.open(g.ROOT_KEY_CURRENT_USER,a,g.ACCESS_READ)}else{if(c=="HKEY_CLASSES_ROOT"){ATB.Logger.debug("Opening regKeyService using rootKey HKEY_CLASSES_ROOT");g.open(g.ROOT_KEY_CLASSES_ROOT,a,g.ACCESS_READ)}else{if(c=="HKEY_LOCAL_MACHINE"){ATB.Logger.debug("Opening regKeyService using rootKey HKEY_LOCAL_MACHINE");g.open(g.ROOT_KEY_LOCAL_MACHINE,a,g.ACCESS_READ)}else{ATB.Logger.debug("Opening regKeyService using rootKey HKEY_CURRENT_USER");g.open(g.ROOT_KEY_CURRENT_USER,a,g.ACCESS_READ)}}}if(typeof(d)!="undefined"&&d.length>0&&d=="TYPE_INT"){f=0;ATB.Logger.debug("Reading *integer* value from the registry per the registryType param..");f=g.readIntValue(e)}else{ATB.Logger.debug("Reading *string* value from the registry per the registryType param..");f=g.readStringValue(e)}ATB.Logger.info('*Read* value: "',f,'" for key: "',e,'" using path: ',a);g.close()}catch(b){if(e==this.QSRC_MACRO||e==this.LOCALE_MACRO||e==this.OVER_INSTALL_MACRO||e==this.LOCATION_MACRO){ATB.Logger.warn('Could not retrieve registry entry (it might not exist): "',e,'" from location: ',a)}else{ATB.Logger.error('Could not retrieve registry entry (it might not exist): "',e,'" from location: ',a,". Error: ",b)}}}}}return f},writeRegistryEntry:function(d,e,a,c){ATB.Logger.debug('Writing registry entry (name/value): "',d,"/",e,'" to: ',a,". rootKey: ",c);var g=false;if(this.isWindowsOS()){var f=this.getRegKeyService();if(f){if(typeof(a)=="undefined"||a==null||a.length==0){ATB.Logger.error("regPathUnderRoot is not specified or empty: ",a)}else{try{if(typeof(c)=="undefined"||c==null){f.open(f.ROOT_KEY_CURRENT_USER,a,f.ACCESS_WRITE)}else{if(c=="ROOT_KEY_CLASSES_ROOT"){f.open(f.ROOT_KEY_CLASSES_ROOT,a,f.ACCESS_WRITE)}else{if(c=="ROOT_KEY_LOCAL_MACHINE"){f.open(f.ROOT_KEY_LOCAL_MACHINE,a,f.ACCESS_WRITE)}else{f.open(f.ROOT_KEY_CURRENT_USER,a,f.ACCESS_WRITE)}}}f.writeStringValue(d,e);ATB.Logger.info('*Wrote* value: "',e,'" for key: "',d,'" using path: ',a);f.close();g=true}catch(b){ATB.Logger.error('Could not set registry value: "',e,'" at: ',a,". Error: ",b)}}}}return g},getRegistryEntryFromMacroFolderAsStr:function(a){return ATB.Utils.getRegistryEntry(a,ATB.Utils.getMacrosRegLocation(),"TYPE_STR","HKEY_LOCAL_MACHINE")},writeRegistryEntryInMacroFolderAsStr:function(b,a){return ATB.Utils.writeRegistryEntry(b,a,ATB.Utils.getMacrosRegLocation(),"ROOT_KEY_LOCAL_MACHINE")},getWindowObjHostingATB:function(){if(document.getElementById("asktb")){return window}else{if(window.opener.document.getElementById("asktb")){return window.opener}else{return window.opener.opener}}},getDocObjHostingATB:function(){return this.getWindowObjHostingATB().document},getMaxEntriesForButton:function(a){try{return parseInt(document.getElementById(a).getAttribute("maxEntries"))}catch(b){ATB.Logger.error('"maxEntries attribute must be present for the button: ',a);return 7}},evaluateXPath:function(b,a){var c=function(){return document.documentElement.namespaceURI};var d=document.createExpression(b,c);return d.evaluate(a,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)},evaluateXPathExprForAStringValue:function(d,c){var a="";if(d){var b=d.evaluate(c,d,null,XPathResult.STRING_TYPE,null);if(b){a=b.stringValue}}return a},getStringValueUsingXPathExpr:function(c,a){var b=this.evaluateXPathExprForAStringValue(c,a);if(b!=null&&b.length>0){b=this.trim(b)}else{ATB.Logger.debug("Could not retrieve using the expression ",a," from the xml response: ",this.evaluateXPathExprForAStringValue(c,"/"));b=""}return b},getChildNodesWithAttribute:function(b,d){var c=new XPathEvaluator();var a=c.createNSResolver(b.ownerDocument==null?b.documentElement:b.ownerDocument.documentElement);return c.evaluate("//*[@"+d+"]",b,a,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null)},getElementsByClassName:function(b,a){var f=[];if(!a){a=document}if(document.getElementsByClassName){f=a.getElementsByClassName(b)}else{var e=".//.[@class='"+b+"']";var d=ATB.Utils.evaluateXPath(e,a);for(var c=0;c<d.snapshotLength;c++){f.push(d.snapshotItem(c))}}return f},refreshNode:function(b){var a=b.parentNode;a.removeChild(b);a.appendChild(b)},getToolbarDocumentFromFile:function(){var b=ATB.Utils.getFileHandleUnderInstallLocation(ATB.Constants.FILE_ATB_XUL);var a="file:///"+b.target;var b=this.getFileContents(a);var d=null;try{d=(new DOMParser()).parseFromString(b,"application/xml")}catch(c){ATB.Logger.error("getToolbarDocumentFromFile: Unable to parse toolbar XUL from: ",a,". Error: ",c)}return d},getFileContents:function(a){var g="";try{var f=Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService);var e=Components.classes["@mozilla.org/scriptableinputstream;1"].getService(Components.interfaces.nsIScriptableInputStream);var d=f.newChannel(a,null,null);var b=d.open();e.init(b);g=e.read(b.available());e.close();b.close()}catch(c){ATB.Logger.error("getFileContents: Unable to open and read: ",a," Error: ",c)}return g},getTimestamp:function(){var a=new Date().toUTCString();return a.replace(/\ /g,"-").replace(/:/g,"-").replace(/,/g,"").replace(/\//g,"-")},trim:function(c){c=c.replace(/^\s\s*/,"");var a=/\s/;var b=c.length;while(a.test(c.charAt(--b))){}return c.slice(0,b+1)},isEmptyOrNull:function(a){return a!=null&&this.trim(a)!=""},stringToToolbarFunction:function(c){var e=ATB,d=ATB,b=c.split(".");for(var a=0;a<b.length;a++){if(d===undefined||d===null){break}d=d[b[a]];if(a==(b.length-2)){e=d}}return(typeof(d)=="function")?this.hitch(e,d):null},getOrigin:function(){return"0"},updateAskUrlInSearchPlugin:function(j){ATB.Logger.info("Updating the Ask.com search plugin url... File path: ",j);var c=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);ATB.Logger.debug("Creating a search plugin file and initializing it with the path: ",j);c.initWithPath(j);ATB.Logger.debug("Got a handle on the search plugin file: ",c.path);var e=ATB_Utilities.getLocalFileContentsAsLinesArray(c);ATB.Logger.debug("Read search plugin file: ",e);var g="",b=null;var f=ATB.Prefs.getRedirectUriForChrome();var h=new RegExp('"(https?://\\w+\\.'+ATB.Prefs.getSearchSiteDomain()+'/redirect.+)"');var a=new RegExp("<SearchForm>(.*)</SearchForm>$","i");ATB.Logger.info("Using Redirect API regex for matching in search plugin files: ",h);for(var d=0;d<e.length;d++){if(e[d]&&e[d].length>0){if(f&&f.length>0){b=e[d].match(h);if(typeof(b)!="undefined"&&b&&b.length>0){ATB.Logger.info("Redirect API Match found: ",b[1]);ATB.Logger.info("Replacing the redirect API uri present with: ",f,". Macros will be replaces with their latest values..");e[d]=e[d].replace(h,('"'+f+'"'));ATB.Logger.info("Replace complete: ",e[d])}}if(a.test(e[d])){e[d]=ATB.Prefs.replaceTbMacros(e[d])}e[d]=e[d]+"\n";g=g+e[d]}}ATB.Logger.debug("Updated search plugin file (with o and l params): ",g);this.writeContentsToLocalFile(g,j,false);ATB.Logger.debug("Search plugin file (",j,") update complete.");return},updateAskSSUrlInSearchPlugin:function(j){ATB.Logger.info("Updating the Search Suggestions URL in Ask.com search plugin ... File path: ",j);var b=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);b.initWithPath(j);var e=ATB_Utilities.getLocalFileContentsAsLinesArray(b);ATB.Logger.debug("Read search plugin file: ",e);var f="";var d=ATB.Prefs.getChromeSearchSuggestionsUrl();d=(d.replace(/&/g,"&amp;")).replace(/"/g,"&quot;");const g=/suggestions/,h=/\/SearchPlugin/;var a=false;for(var c=0;c<e.length;c++){var k=e[c];if(g.test(k)){ATB.Logger.info("Search Suggestion Url Match found on line: ",k);ATB.Logger.info("Replacing the Search Suggestion Url present with: ",d,". Macros will be replaces with their latest values..");k='<os:Url type="application/x-suggestions+json" method="GET" template="'+d+'"></os:Url>';a=true;ATB.Logger.info("Replace complete: ",e[c])}if(!a&&h.test(k)){k='<os:Url type="application/x-suggestions+json" method="GET" template="'+d+'"></os:Url>\n'+k+"\n";ATB.Logger.info("There was no existing search suggestion entry. Adding entry: ",k)}else{k=k+"\n"}f=f+k}ATB.Logger.debug("Updated search plugin file (with o and l params): ",f);this.writeContentsToLocalFile(f,j,false);ATB.Logger.debug("Search plugin file (",j,") update for SS complete.")},makeAskDefaultForChromeSearch:function(){if(ATB.Prefs.isSAEnabled()){ATB.Logger.info("Making Ask.com the default search engine provider for chrome search...");var d=Components.classes["@mozilla.org/browser/search-service;1"].getService(Components.interfaces.nsIBrowserSearchService);var b=ATB.Prefs.getSearchPluginEngineName();ATB.Logger.debug("Using search engine id (",b,") with service: ",d);var a=d.getEngineByName(b);if(a){ATB.Logger.debug("Setting Ask.com as the default chrome search engine. Engine name: ",a.name,". Description: ",a.description,". Search Form: ",a.searchForm);a.hidden=false;d.moveEngine(a,0);if(d.currentEngine!=a){ATB.Logger.debug('Setting "current" engine to: ',b);d.currentEngine=a}}else{ATB.Logger.error("Could not find search engine plugin file... Cannot set the default chrome search engine.")}var c=ATB.Prefs.getBrowserPrefsBranch();ATB.Prefs.setCharPref(ATB.Constants.BROWSER_SELECTED_ENGINE_PREF,b,c);ATB.Prefs.setCharPref(ATB.Constants.BROWSER_DEFAULT_ENGINE_PREF,b,c);ATB.Prefs.setCharPref(ATB.Constants.BROWSER_DEFAULT_ENGINE_NAME_PREF,b,c);ATB.Prefs.setCharPref(ATB.Constants.BROWSER_SEARCH_ORDER_1_PREF,b,c);ATB.Logger.debug("Done setting ",b," as the default search engine in the chrome.")}else{ATB.Logger.info("Search Assist (SA) is disabled. makeAskDefaultForChromeSearch update is skipped.")}},getATBKeywordUrl:function(){ATB.Logger.info("Using Redirect API for keyword.URL, Replacing macros with the latest values, and removing {query} macro...");return ATB.Prefs.replaceTbMacros(ATB.Prefs.getRedirectUri().replace(/{query}/g,""))},updateKeywordUrlForSearchAssist:function(){if(ATB.Prefs.isSAEnabled()){var b=ATB.Prefs.getKeywordURLPref();ATB.Logger.info("Storing original keyword pref: ",b);if(!ATB.Prefs.getOriginalKeywordURLPref()){ATB.Prefs.setOriginalKeywordURLPref(b?b:ATB.Prefs.getCharPref(ATB.Constants.ATB_FF_KEYWORDURL_DEFAULTURI_PREF))}var a=this.getATBKeywordUrl();ATB.Prefs.setKeywordURLPref(a);ATB.Prefs.enableKeywordURL(true);ATB.Logger.info('Updated current "keyword.URL" to: "',a,'". keyword.enabled will be set to "true" as well.');ATB.Logger.debug("Done: updateKeywordUrlForSearchAssist")}else{ATB.Logger.info("Search Assist (SA) is disabled. Keyword.Url update is skipped.")}return},unsetKeywordUrlForSearchAssist:function(){var a=this.getATBKeywordUrl();var b=ATB.Prefs.getKeywordURLPref();if(a!=b){ATB.Logger.info("unsetKeywordUrlForSearchAssist: keyword.URL was changed to ",b,"after toolbar install, SO not touching it ")}else{var c=ATB.Prefs.getOriginalKeywordURLPref();if(c){ATB.Logger.info("unsetKeywordUrlForSearchAssist: keyword.URL will be set to originalKeywordUrl:",c);ATB.Prefs.setKeywordURLPref(c)}else{ATB.Logger.info("unsetKeywordUrlForSearchAssist: keyword.URL will be set to the default Mozilla keyword-url");ATB.Prefs.setKeywordURLPref(ATB.Prefs.getCharPref(ATB.Constants.ATB_FF_KEYWORDURL_DEFAULTURI_PREF))}}},navigateBadDnsDomainToAskResults:function(c){if(ATB.Prefs.isSAEnabled()){ATB.Logger.info("Forwarding to Ask.com's search results for the domain in context: ",c);var a=ATB.Prefs.getRedirectUri();ATB.Logger.debug("Using dns uri mask: ",a);var b=a.replace(/{query}/g,c);ATB.Logger.debug("Using Ask.com web channel url: ",b);ATB.Core.navigateToUrl(null,b)}return},isValidUrl:function(b){var c=false;if(b&&b.length>0){var a=b.match(/(^https?:\/\/.+)/);if(a&&a.length>0){c=true}}return c},isString:function(a){return !!arguments.length&&a!=null&&(typeof a=="string"||a instanceof String)},hitch:function(b,a){if(ATB.Utils.isString(a)){return function(){return b[a].apply(b,arguments)}}else{return function(){return a.apply(b,arguments)}}},get:function(a){return document.getElementById(a)},connect:function(c,b,a,d){if(!b.search("on")){b=b.substr(2)}c.addEventListener(b,this.hitch(a,d),false)},_subs:{},subscribe:function(d,c,b,a){if(!this._subs[d]){this._subs[d]=[]}var e=this._subs[d].push({scope:c,handler:b,args:a});var f=d+";"+e;return f},unsubscribe:function(d){var c=d.split(";");var b=c[0];var a=parseInt(c[1]);a--;delete this._subs[b][a]},publish:function(h,c){if(this._subs[h]){var f=this._subs[h],g,a;try{for(var d=0;d<f.length;d++){g=f[d];a=g.args.concat(c);if(this.isString(g.handler)){g.scope[g.handler].apply(g.scope,a)}else{g.hanlder.apply(g.scope,a)}}}catch(j){if(g&&g.handler){var b=" handler: "+g.handler}else{var b=""}throw"bad publish, type: "+h+b+" e: "+j}}},topics:{BROWSER_LOADED_PAGE:"asktb/browser/load/page"},stopEvent:function(a){a.preventDefault();a.stopPropagation()},formatDate:function(l,h,e){var f=new Date(h);var c=e?new Date(e):new Date();var d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var r=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var p=f.getMonth();var k=f.getFullYear();var b=c.getTime()-f.getTime();if(b===0||b<0){return"a moment ago"}var o=[];if(b<(24*3600*1000)){var n=c.getHours()-f.getHours();var g=c.getMinutes()-f.getMinutes();var q=c.getSeconds()-f.getSeconds();if(n<0){n+=24}if(g<0){g+=60;n--}if(q<0){q+=60;g--}if(n>0){if(n>1){o.push(n,"hours")}else{o.push("about an hour")}}if(g>0){if(g>1){o.push(g,"minutes")}else{o.push("about a minute")}}if(n==0&&g==0){if(q>5){o.push(q,"seconds")}else{o.push("a moment")}}o.push("ago");o=o.join(" ")}else{var a;if(l){a=""}else{var n=f.getHours()%12;var g=f.getMinutes();var j=(g<10)?"0":"";var m=(f.getHours()<12)?"AM":"PM";if(n==0){n=12}a=n+":"+j+g+" "+m}if(b<(2*24*3600*1000)){o="Yesterday at "+a}else{if(b<(6*24*3600*1000)){o=r[f.getDay()]+" "+a}else{o=d[p]+" "+f.getDate()+", "+k+" at "+a}}}return o},getLocalFileContentsAsLinesArray:ATB_Utilities.getLocalFileContentsAsLinesArray,writeContentsToLocalFile:function(c,b,d){var e=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);ATB.Logger.debug("Creating a new file and initializing it with the path: ",b,". createUnique is set to ",d);e.initWithPath(b);if(typeof(d)!="undefined"&&d){e.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE,600)}var f=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);try{f.init(e,4|8|32,384,0);ATB.Logger.debug("Writing file contents to stream: ",f);f.write(c,c.length);ATB.Logger.debug("New file saved to the file system: ",b)}catch(a){ATB.Logger.error("Error encountered while *writing* to nsIFileOutputStream instance: ",f,". filePath: ",b,'. fileContents.length: "',c.length,'" bytes. Error: ',a);e=null}finally{if(f){if(f instanceof Components.interfaces.nsISafeOutputStream){ATB.Logger.debug("Finishing stream: ",f);f.finish()}else{ATB.Logger.debug("Closing stream: ",f);f.close()}ATB.Logger.debug("... Writing process complete. Returning file instance: ",e)}else{ATB.Logger.error("Stream instance (for @mozilla.org/network/safe-file-output-stream;1) is null!")}}return e},loadScriptContentInSandbox:function(c,b){ATB.Logger.debug("loadScriptContentInSandbox");if(!b){b={}}var a=ATB.Utils.getFileHandleUnderInstallLocation(ATB.Constants.ATB_TEMP_SCRIPT_RELATIVE_PATH+"temp.js");a=ATB.Utils.writeContentsToLocalFile(c,a.path,true);ATB.Utils.loadLocalScriptInSandbox(ATB.Constants.ATB_TEMP_SCRIPT_CHROME_URL+a.leafName,b);try{a.remove(false)}catch(d){ATB.Logger.error("loadRemoteScriptInSandbox: Error removing temp file -- ",d)}return b},loadLocalScriptInSandbox:function(b,a){ATB.Logger.debug("loadLocalScriptInSandbox");if(!a){ATB.Logger.error("loadLocalScriptInSandbox: 'sandbox' parameter missing or null.");return}var d=Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);try{d.loadSubScript(b,a)}catch(c){ATB.Logger.error("Unable to load local script: ",c)}},getAvailableBrowserWidth:function(){return window.innerWidth},getAllBrowserWindows:function(){var a=Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator);return a.getEnumerator("navigator:browser")},saveInMemoryPrefsToFileSystem:function(){var c=false;try{ATB.Logger.info("Saving modified  in-memory preferences to prefs.js");var b=ATB_Utilities.getProfileDirectory();if(b&&b.path.length>0){ATB.Logger.info("Using profileDir path: ",b.path);b.append("prefs.js");var d=b;ATB.Logger.info("Using prefsJSFile path: ",d.path);ATB.Prefs.getPrefsService().savePrefFile(d);ATB.Logger.info("Saved in-memory prefs to prefs.js!");c=true}else{ATB.Logger.error("Unable to calculate the profile path! In-memory prefs will not be written to the file-system.")}}catch(a){ATB.Logger.error("Error occured while calculating the profile path. Error: ",a)}return c},isFirefoxShuttingDown:function(){return this.shuttingDown},restartFirefox:function(){try{var a=ATB.Prefs.getOverlayReloadedUsingRestartFlag();if(!a){ATB.Prefs.setOverlayReloadedUsingRestartFlag(true);var d=this.saveInMemoryPrefsToFileSystem();if(d){ATB.Logger.info('RESTARTING FIREFOX... Overlay reload flag set to "true".');try{ATB_unload(null)}catch(f){ATB.Logger.error("Error calling ATB_unload: ",f)}this.shuttingDown=true;var c=Components.interfaces.nsIAppStartup;Components.classes["@mozilla.org/toolkit/app-startup;1"].getService(c).quit(c.eRestart|c.eAttemptQuit)}else{ATB.Logger.error("Firefox RESTART will NOT be kicked off since the in-memory prefs could not written to the file system. Otherwise an infinite restart loop occurs!")}}else{ATB.Logger.warn("*** Firefox can NOT be restarted because it was already restarted once. Current overlayReloadedFlag: ",a)}}catch(b){ATB.Logger.error("Error restarting firefox: ",b)}return},getToolbarInstallDir:function(){var a=ATB_Utilities.getProfileDirectory();a.append("extensions");a.append(this.PREFS_BRANCH.getCharPref(ATB.Constants.ATB_ID_PREF));if(a.exists()&&a.isFile()){var b=ATB_Utilities.getExtensionDirectoryFromFile(a);if(b){a=b}}return a},getFileHandleUnderInstallLocation:function(a){var c=a.split("/");var d=this.getToolbarInstallDir();for(var b=0;b<c.length;b++){if(c[b]!=""){d.append(c[b])}}return d},getProfileDirectory:ATB_Utilities.getProfileDirectory,getToolbarDatastoreDir:function(){return ATB.Utils.getFileHandleUnderInstallLocation("/datastore")},getSkinDir:function(){var a=ATB.Utils.getFileHandleUnderInstallLocation("/");ATB.Logger.debug("Using ATB install directory to identify the skin dir: ",a.path);a.append("chrome");a.append("skin");return a},getContentDir:function(){var a=ATB.Utils.getFileHandleUnderInstallLocation("/");ATB.Logger.debug("Using ATB install directory to identify the content dir: ",a.path);a.append("chrome");a.append("content");return a},getCurrentUrl:function(){var a=this.getWindowObjHostingATB(),c=null,b;if(a){b=a.content.location.href;if(b&&(b.length>0)&&(b.indexOf("chrome://")!=0)){c=b}}return c},getCurrentHost:function(){var c=null,a,b;b=this.getCurrentUrl();if(b){a=b.match(/\/\/(.+?)\//);if(a!=null&&a.length>0){c=a[1]}else{c=b}}else{ATB.Logger.warn("Current document's URL is null (must be a chrome URL or is empty). Unable to get current host.")}return c},getLocalizedStringForKey:function(f,e){if(typeof(e)=="undefined"||e==null){e=document}var a=null;try{if(f.indexOf("$")!=0){var c=e.getElementById(ATB.Constants.ATB_LOCALIZED_LABELS);if(c!=null){a=c.getString(f)}else{ATB.Logger.error('Error finding string bundle node in the DOM!! documentObjHostingATB: "',e.documentURI,'"')}}else{var b=e.getElementById(ATB.Constants.ATB_LOCALIZED_LINKS);if(b!=null){a=b.getString(f)}else{ATB.Logger.error('Error finding string bundle node in the DOM!! documentObjHostingATB: "',e.documentURI,'"')}}}catch(d){ATB.Logger.warn("Error finding localized string for key: ",f,". Error: ",d)}return a},getUrlParamMap:function(a){var e={};var f=a.split("?");if(f.length>1){var d=f[1].split("&");for(var c=0;c<d.length;c++){var b=d[c].split("=");e[b[0].toLowerCase()]=b[1]}}return e},addUrlParams:function(a,c){if(c){if(a.charAt(0)!="?"){a+="?"}for(var b in c){if(a[a.length-1]!="?"){a+="&"}a=a+(b+"="+escape(c[b]))}}return a},replaceEnvVariables:function(e){try{if(e.indexOf("%")!=-1){ATB.Logger.debug(e," has a environment var in it. Replacing it.");var c=Components.classes["@mozilla.org/process/environment;1"].getService(Components.interfaces.nsIEnvironment);var d=e.split("\\");if(d.length==1){d=e.split("/")}for(i=0;i<d.length;i++){if(d[i].indexOf("%")==0){var b=d[i];if((b=c.get(d[i].substring(1,d[i].indexOf("%",1))))!=""){d[i]=b}}}e=d.join("\\");ATB.Logger.debug("New AppPath after replacing environment variables :",e)}}catch(a){ATB.Logger.error("Error while replacing ENV variables in  string :",e," ,Error:",a)}return e},_verificationEXE:null,verifyExecutable:function(d,k,p){ATB.Logger.info("Entering ATB.Utils.verifyExecutable");var m,o,h,j,g,c,n;try{var b=Components.interfaces;var f=Components.classes;d.QueryInterface(b.nsILocalFile);if(!d.isExecutable()){throw new Error(d.path+" is not executable")}if(!this._verificationEXE){m=f["@mozilla.org/network/io-service;1"].getService(b.nsIIOService);o=m.newURI(ATB.Constants.EXECUTABLE_VERIFICATION_URL,null,null);h=f["@mozilla.org/chrome/chrome-registry;1"].getService(b.nsIChromeRegistry);j=h.convertChromeURL(o);this._verificationEXE=j.QueryInterface(b.nsIFileURL).file}var c=f["@mozilla.org/process/util;1"].createInstance(b.nsIProcess);c.init(this._verificationEXE);n=[d.path];var a={observe:function(){p(c.exitValue===0)}};if(this.getBrowserVersion()<=3){k=true}if(k){c.run(true,n,n.length);a.observe()}else{c.runAsync(n,n.length,a,false)}}catch(l){if(ATB.Logger.isErrorEnabled()){ATB.Logger.error("ATB.Utils.verifyExecutable error: "+l)}p(false)}ATB.Logger.info("Clearing ATB.Utils.verifyExecutable");return true}};