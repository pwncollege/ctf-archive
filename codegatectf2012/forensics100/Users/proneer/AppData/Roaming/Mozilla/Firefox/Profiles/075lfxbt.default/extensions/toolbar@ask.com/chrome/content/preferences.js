/*
 * Copyright (C) 2008-2010 APN, LLC. All rights reserved
 * References to external sources embedded in the code.
 * 
 * Author: Vishal Shah
 * Description: Toolbar Preferences.
 */
var ATB_Preferences=function(){this.PREFS_SERVICE=Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService);this.PREFS_BRANCH=this.PREFS_SERVICE.getBranch(ATB.Constants.ATB_EXT_PREFS_BRANCH);this.BROWSER_PREFS_BRANCH=this.PREFS_SERVICE.getBranch("browser.");this.prefListener=null;this.REGEX_PREF_MACRO="{pref_(.*?)}";this.load()};ATB_Preferences.prototype={load:function(){ATB.Logger.info("Start *Prefs* Init...");this.setPrefListeners();this.loadPreferencesFromConfigFile();ATB.Logger.info("End *Prefs* Init...")},unload:function(a){ATB.Logger.info("Unloading toolbar preferences...");this.unsetPrefListeners();ATB.Logger.info("Done unloading the toolbar preferences.");return},getPrefsService:function(){return this.PREFS_SERVICE},setPrefListeners:function(){this.prefListener=new ATB_PrefListener(ATB.Constants.ATB_EXT_PREFS_BRANCH,function(b,a){switch(a){default:}});this.prefListener.register()},unsetPrefListeners:function(){if(this.prefListener){this.prefListener.unregister()}},getPrefValueAsString:function(a,b){if(!b){b=this.PREFS_BRANCH}var c="";try{switch(b.getPrefType(a)){case b.PREF_INT:c=""+b.getIntPref(a);break;case b.PREF_BOOL:c=""+b.getBoolPref(a);break;case b.PREF_STRING:default:c=b.getCharPref(a);break}}catch(d){ATB.Logger.warn("getPrefValueAsString: Error retrieving preference named: ",a," Msg: "+d);c=""}return c},getBoolPref:function(c,d){var a="";try{if(typeof(d)=="undefined"){a=this.PREFS_BRANCH.getBoolPref(c)}else{a=d.getBoolPref(c)}}catch(b){ATB.Logger.warn("Error retrieving bool preference: ",c," , Error:",b)}return a},setBoolPref:function(a,c,b){if(typeof(b)=="undefined"){this.PREFS_BRANCH.setBoolPref(a,c)}else{b.setBoolPref(a,c)}},setBoolPrefFromMap:function(a){if(a.name&&a.value){this.PREFS_BRANCH.setBoolPref(a.name,(a.value=="false")?false:a.value)}},getCharPref:function(c,d){var a="";try{if(typeof(d)=="undefined"){a=this.PREFS_BRANCH.getCharPref(c)}else{a=d.getCharPref(c)}}catch(b){ATB.Logger.warn("Error retrieving char preference: ",c," , Error:",b)}if(a&&a.length>0){a=ATB.Utils.trim(a)}return a},setCharPref:function(a,c,b){if(typeof(b)=="undefined"){this.PREFS_BRANCH.setCharPref(a,c)}else{b.setCharPref(a,c)}},setCharPrefFromMap:function(a){if(a.name&&a.value){this.PREFS_BRANCH.setCharPref(a.name,a.value)}},loadPreferencesFromConfigFile:function(){if(this.getFirstRestartAfterConfigUpdate()===true){var d=null;if(typeof(ATB_Config)!="undefined"){d=ATB_Config;ATB.Logger.info("Loaded config from toolbar.xul")}else{try{var c=ATB.Utils.getFileHandleUnderInstallLocation(ATB.Constants.ATB_CONFIG_FILE_PATH_UNDER_INSTALL_LOCATION);if(!c.exists()){ATB.Logger.debug("The config.js does not exist , so skipping the processing for it");return}else{ATB.Logger.debug("Trying to load config.js");var a=new Object();var b=Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);b.loadSubScript(ATB.Constants.ATB_CONFIG_FILE_LOCATION,a);ATB.Logger.debug("config.js loaded sucessfully, with Prefs Branch :",this.PREFS_BRANCH.toString());d=a.ATB_Config;ATB.Logger.info("Loaded config from content/config.js")}}catch(j){ATB.Logger.error("Error occured while loading preferences from the config.js file"+j)}}if(d){var f;var h;var i;var k;for(var g in d){f=g.toString();h=d[g].value;i=d[g].override;if(f.indexOf(".")!=-1){k=this.PREFS_SERVICE.getBranch("")}if(typeof h=="boolean"){if(this.getBoolPref(f,k)==""||(i&&i===true)){this.setBoolPref(f,h,k);ATB.Logger.debug("The value for the pref:",f," changed to ",this.getBoolPref(f,k))}else{ATB.Logger.debug("The value for the pref:",f,"is not changed, as it is already set")}}else{if(this.getCharPref(f,k)==""||(i&&i===true)){this.setCharPref(f,h,k);ATB.Logger.debug("The value for the pref:",f," changed to ",this.getCharPref(f,k))}else{ATB.Logger.debug("The value for the pref:",f,"is not changed, as it is already set")}}}}else{ATB.Logger.warn("No config detected, thus ignoring")}}},getLastSearchTimeStamp:function(){return this.getCharPref(ATB.Constants.ATB_LAST_SEARCH_TIME_STAMP)},setLastSearchTimeStamp:function(a){this.setCharPref(ATB.Constants.ATB_LAST_SEARCH_TIME_STAMP,a)},getFirstRestartAfterConfigUpdate:function(){return this.getBoolPref(ATB.Constants.ATB_FIRST_RESTART_AFTER_CONFIG_UPDATE)},setFirstRestartAfterConfigUpdate:function(a){this.setBoolPref(ATB.Constants.ATB_FIRST_RESTART_AFTER_CONFIG_UPDATE,a)},getRecentMapsSearches:function(){return this.getCharPref(ATB.Constants.ATB_MAPS_SEARCHES_PREF)},setRecentMapsSearches:function(a){this.setCharPref(ATB.Constants.ATB_MAPS_SEARCHES_PREF,a)},getRecentSearchHistory:function(){return this.getCharPref(ATB.Constants.ATB_SEARCHES_PREF)},setRecentSearchHistory:function(a){this.setCharPref(ATB.Constants.ATB_SEARCHES_PREF,a)},showLabels:function(){return this.getBoolPref(ATB.Constants.ATB_SHOW_LABELS_PREF)},setShowLabels:function(a){this.setBoolPref(ATB.Constants.ATB_SHOW_LABELS_PREF,a)},saveSearches:function(){return this.getBoolPref(ATB.Constants.ATB_SAVE_SEARCHES_PREF)},setSaveSearches:function(a){this.setBoolPref(ATB.Constants.ATB_SAVE_SEARCHES_PREF,a)},clearSearchesOnExit:function(){return this.getBoolPref(ATB.Constants.ATB_CLEAR_SEARCHES_ON_EXIT_PREF)},setClearSearchesOnExit:function(a){this.setBoolPref(ATB.Constants.ATB_CLEAR_SEARCHES_ON_EXIT_PREF,a)},getBrowserPrefsBranch:function(){return this.getPrefsService().getBranch("browser.")},getHomePagePref:function(){return this.getCharPref(ATB.Constants.BROWSER_HOMEPAGE_PREF,this.getBrowserPrefsBranch())},setHomePagePref:function(a){this.setCharPref(ATB.Constants.BROWSER_HOMEPAGE_PREF,a,this.getBrowserPrefsBranch())},getHPREnabledPref:function(){return this.getCharPref(ATB.Constants.ATB_HPR_ENABLED)},getHPRUrlPref:function(){return this.getCharPref(ATB.Constants.ATB_HPR_URL)},getKeywordPrefsBranch:function(){return this.getPrefsService().getBranch("keyword.")},getGeneralPrefsBranch:function(){return this.getPrefsService().getBranch("general.")},getOriginalKeywordURLPref:function(){return this.getCharPref(ATB.Constants.ATB_FF_ORIGINAL_KEYWORD_URL)},setOriginalKeywordURLPref:function(a){this.setCharPref(ATB.Constants.ATB_FF_ORIGINAL_KEYWORD_URL,a)},getKeywordURLPref:function(){return this.getCharPref(ATB.Constants.KEYWORD_URL_PREF,this.getKeywordPrefsBranch())},setKeywordURLPref:function(a){this.setCharPref(ATB.Constants.KEYWORD_URL_PREF,a,this.getKeywordPrefsBranch())},enableKeywordURL:function(a){this.setBoolPref(ATB.Constants.KEYWORD_ENABLED_PREF,a,this.getKeywordPrefsBranch())},resetKeywordURLPref:function(b){var c=this.getDefaultFirefoxKeywordUrl();var a=this.getOriginalKeywordURLPref();if(a&&a.length>0){ATB.Logger.info("Resetting keyword.URL (kw search) to the original URL: ",a);this.setKeywordURLPref(a)}else{ATB.Logger.info("Resetting keyword.URL (kw search) to the FF default: ",c);this.setKeywordURLPref(c)}},getDefaultFirefoxKeywordUrl:function(){return this.getCharPref(ATB.Constants.ATB_FF_KEYWORDURL_DEFAULTURI_PREF)},getSearchPluginEngineName:function(){return this.getCharPref(ATB.Constants.PREF_SEARCH_PLUGIN_ENGINE_NAME)},getSearchPluginFilename:function(){return this.getCharPref(ATB.Constants.PREF_SEARCH_PLUGIN_ENGINE_FILE)},getSearchSiteDomain:function(){return this.getCharPref(ATB.Constants.PREF_SEARCH_SITE_DOMAIN)},getCobrandId:function(){return this.getCharPref(ATB.Constants.ATB_COBRANDID_PREF)},getBarOrigin:function(){return this.getCharPref(ATB.Constants.ATB_BARORIGIN_PREF)},getDistributionType:function(){return this.getCharPref(ATB.Constants.ATB_DISTYPE_PREF)},getDistributionTrackId:function(){return this.getCharPref(ATB.Constants.ATB_DIS_TRACK_ID_PREF)},getConfigRefreshInterval:function(){return this.getCharPref(ATB.Constants.ATB_CONFIGREFRESH_PREF)},getFeedRefreshInterval:function(){return this.getCharPref(ATB.Constants.ATB_FEEDREFRESH_PREF)},getSyncRequestTimeout:function(){return this.getCharPref(ATB.Constants.ATB_SYNC_REQUEST_TIMEOUT)},hasTbLocaleChangedViaOptions:function(){return this.getBoolPref(ATB.Constants.ATB_LOCALE_CHANGED_VIA_OPTIONS_PREF)},setTbLocaleChangedViaOptions:function(a){this.setBoolPref(ATB.Constants.ATB_LOCALE_CHANGED_VIA_OPTIONS_PREF,a)},getTbMacrosRegLocation:function(){return this.getCharPref(ATB.Constants.ATB_MACROS_REG_LOCATION_PREF)},isFreshInstall:function(){return this.getBoolPref(ATB.Constants.ATB_FRESHINSTALL_PREF)},setFreshInstall:function(a){this.setBoolPref(ATB.Constants.ATB_FRESHINSTALL_PREF,a)},isFirstLaunch:function(){return this.getBoolPref(ATB.Constants.ATB_FIRSTLAUNCH_PREF)},setFirstLaunch:function(a){this.setBoolPref(ATB.Constants.ATB_FIRSTLAUNCH_PREF,a)},getFirstLaunchUrl:function(){return this.getCharPref(ATB.Constants.ATB_FIRSTLAUNCH_URL_PREF)},setFirstLaunchUrl:function(a){this.setCharPref(ATB.Constants.ATB_FIRSTLAUNCH_URL_PREF,a)},getOverlayReloadedUsingRestartFlag:function(){return this.getBoolPref(ATB.Constants.ATB_OVERLAY_RELOADED_USING_RESTART_PREF)},setOverlayReloadedUsingRestartFlag:function(a){this.setBoolPref(ATB.Constants.ATB_OVERLAY_RELOADED_USING_RESTART_PREF,a)},getLastConfigReq:function(){return this.getCharPref(ATB.Constants.ATB_LASTCONFIGREQ_PREF)},setLastConfigReq:function(a){this.setCharPref(ATB.Constants.ATB_LASTCONFIGREQ_PREF,a)},getDefaultChannel:function(){return this.getCharPref(ATB.Constants.ATB_DEFAULT_CHANNEL_PREF)},setDefaultChannel:function(a){this.setCharPref(ATB.Constants.ATB_DEFAULT_CHANNEL_PREF,a)},getDefaultChannelUrlMask:function(){return this.getCharPref(ATB.Constants.ATB_DEFAULT_CHANNEL_URL_MASK_PREF)},setDefaultChannelUrlMask:function(a){this.setCharPref(ATB.Constants.ATB_DEFAULT_CHANNEL_URL_MASK_PREF,a)},getQSrc:function(){return this.getCharPref(ATB.Constants.ATB_QSRC_PREF)},getUserLocationOnInstall:function(){return this.getCharPref(ATB.Constants.ATB_LOCATION_PREF)},getToolbarLocale:function(){return this.getCharPref(ATB.Constants.ATB_LOCALE_PREF)},setToolbarLocale:function(a,b){if(a&&a.length>0&&(a!=this.getToolbarLocale())){ATB.Logger.info("Setting toolbar locale to: ",a);this.setCharPref(ATB.Constants.ATB_LOCALE_PREF,a);ATB.Logger.info("Done setting locale to: ",this.getToolbarLocale());if(typeof(b)!="undefined"&&b&&b.length>0){this.setTbLocaleChangedViaOptions(true)}}},isNewTabEnabled:function(){return this.getBoolPref(ATB.Constants.ATB_NEW_TAB_ENABLED)},setNewTabEnabled:function(a){this.setBoolPref(ATB.Constants.ATB_NEW_TAB_ENABLED,a)},getNewTabOptOut:function(){return this.getBoolPref(ATB.Constants.ATB_NEW_TAB_OPT_OUT)},setNewTabOptOut:function(a){this.setBoolPref(ATB.Constants.ATB_NEW_TAB_OPT_OUT,a)},getChromeSearchSuggestionsUrl:function(){return this.getCharPref(ATB.Constants.PREF_SEARCH_PLUGIN_SS_URL)},setChromeSearchSuggestionsUrl:function(a){this.setCharPref(ATB.Constants.PREF_SEARCH_PLUGIN_SS_URL,a)},isLoggingEnabled:function(){return this.getBoolPref(ATB.Constants.ATB_LOGGING_ENABLED_PREF)},getLogLevel:function(){return this.getCharPref(ATB.Constants.ATB_LOG_LEVEL_PREF)},getToolbarId:function(){return this.getCharPref(ATB.Constants.ATB_ID_PREF)},getToolbarName:function(){return this.getCharPref(ATB.Constants.ATB_NAME_PREF)},getToolbarVersion:function(){return this.getCharPref(ATB.Constants.ATB_VERSION_PREF)},getLastToolbarVersion:function(){return this.getCharPref(ATB.Constants.ATB_LAST_VERSION_PREF)},setLastToolbarVersion:function(a){this.setCharPref(ATB.Constants.ATB_LAST_VERSION_PREF,a)},getToolbarRevision:function(){return this.getCharPref(ATB.Constants.ATB_REVISION_PREF)},getToolbarBuildNumber:function(){return this.getCharPref(ATB.Constants.ATB_BUILD_PREF)},getToolbarGuid:function(){return this.getCharPref(ATB.Constants.ATB_GUID_PREF)},isSAEnabled:function(){return(this.getCharPref(ATB.Constants.ATB_SA_ENABLED)=="true")},setSAEnabledPref:function(a){this.setCharPref(ATB.Constants.ATB_SA_ENABLED,a.toString())},isSSEnabled:function(){return this.getBoolPref(ATB.Constants.ATB_SS_ENABLED)},setSSEnabled:function(a){this.setBoolPref(ATB.Constants.ATB_SS_ENABLED,a)},isAskBrowseEnabled:function(){return this.getBoolPref(ATB.Constants.ATB_ASK_BROWSE_ENABLED)},setAskBrowseEnabled:function(a){this.setBoolPref(ATB.Constants.ATB_ASK_BROWSE_ENABLED,a)},getSAGuid:function(){return this.getCharPref(ATB.Constants.ATB_SA_GUID_PREF)},getInstalledUri:function(){var a=this.getCharPref(ATB.Constants.ATB_INSTALLEDURI_PREF);a=this.replaceTbMacros(a);return a},getUpdateUri:function(){var a=this.getCharPref(ATB.Constants.ATB_UPDATEURI_PREF);a=this.replaceTbMacros(a);return a},getRedirectUri:function(){var a=this.getCharPref(ATB.Constants.ATB_REDIRECT_URI_PREF);a=this.replaceTbMacros(a);return a},getRedirectUriForChrome:function(){var a=this.getCharPref(ATB.Constants.ATB_REDIRECT_URI_CHROME_PREF);a=this.replaceTbMacros(a);return a},setToolbarLocaleFromLangAndCountry:function(c,d,b){if(c&&c.length>0&&d&&d.length>0){var a=c+"_"+d;ATB.Prefs.setToolbarLocale(a,b)}else{ATB.Logger.error("setToolbarLocaleFromLangAndCountry: Locale *not* updated. Empty toolbar language or country/region passed. lang: ",c," tbCountryOrRegion: ",d)}},getToolbarLanguageInOptions:function(){var a=ATB.Prefs.getCharPref(ATB.Constants.ATB_OPTIONS_LANG);if(!a){a=ATB.Prefs.getToolbarLanguage()}return a},getToolbarLanguage:function(){var a=ATB.Prefs.getToolbarLocale();if(a&&a.length>0){return a.split("_")[0]}else{return ATB.Defaults.ATB_DEFAULT_LANG}},setToolbarLanguage:function(c,a){if(c&&c.length>0){ATB.Logger.debug("setToolbarLanguage: Updating toolbar language to: ",c);var b=this.getToolbarCountryOrRegion();if(c&&c.length>0&&b&&b.length>0){this.setToolbarLocaleFromLangAndCountry(c,this.getToolbarCountryOrRegion(),a)}else{ATB.Logger.error("setToolbarLanguage: Empty toolbar language passed: ",c)}}},getToolbarCountryOrRegion:function(){var a=ATB.Prefs.getToolbarLocale();if(a&&a.length>0){return a.split("_")[1]}else{return ATB.Defaults.ATB_DEFAULT_COUNTRY_OR_REGION}},setToolbarCountryOrRegion:function(b,a){if(b&&b.length>0){ATB.Logger.debug("setToolbarCountryOrRegion: Updating toolbar country/region to: ",b);this.setToolbarLocaleFromLangAndCountry(this.getToolbarLanguage(),b,a);if(ATB.Prefs.isSAEnabled()){ATB.Utils.updateKeywordUrlForSearchAssist()}}else{ATB.Logger.error("setToolbarCountryOrRegion: Empty toolbar country/region passed: ",b)}},macroReplaced:function(a){return a&&a.length>0&&a.charAt(0)!="{"},replaceTbMacros:function(c){var f="";if(c&&c.length>0){f=c.replace(/{browser-lang}/g,this.macroReplaced(ATB.Utils.getBrowserLanguage())?ATB.Utils.getBrowserLanguage():"");f=f.replace(/{current-url}/g,this.macroReplaced(ATB.Utils.getCurrentUrl())?window.encodeURIComponent(ATB.Utils.getCurrentUrl()):"");f=f.replace(/{domain}/g,this.macroReplaced(ATB.Net.getDomainInContext())?ATB.Net.getDomainInContext():"");f=f.replace(/{url.host}/g,this.macroReplaced(ATB.Utils.getCurrentHost())?ATB.Utils.getCurrentHost():"");f=f.replace(/{random}/g,this.macroReplaced(Math.random()*1000000000+"")?(Math.random()*1000000000+""):"");var e=f.match(/{(.*?)}/g),a,b;if(e){for(var d=0;d<e.length;d++){if(e[d]!="{query}"&&e[d]!="{searchTerms}"){macroName=e[d].replace("{","").replace("}","");if(macroName.substr(0,5)=="pref_"){macroName=macroName.substr(5)}b=this.getPrefValueAsString(macroName);f=f.replace(e[d],b)}}}}return f}};function ATB_PrefListener(a,d){var c=Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch(a);c.QueryInterface(Components.interfaces.nsIPrefBranch2);this.register=function(){c.addObserver("",this,false);c.getChildList("",{}).forEach(function(e){d(c,e)})};this.unregister=function b(){if(c){c.removeObserver("",this)}};this.observe=function(f,e,g){if(e=="nsPref:changed"){d(c,g)}}};