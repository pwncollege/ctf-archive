/*
 * Copyright (C) 2008-2010 APN, LLC. All rights reserved
 * References to external sources embedded in the code.
 * 
 * Author: Vishal V. Shah Description: Toolbar event handlers.
 */
var ATB_Events=function(){var a=this;this.progressListener={QueryInterface:function(b){if(b.equals(Components.interfaces.nsIWebProgressListener)||b.equals(Components.interfaces.nsISupportsWeakReference)||b.equals(Components.interfaces.nsISupports)){return this}throw Components.results.NS_NOINTERFACE},onLocationChange:function(c,b,d){if(d){a.handleLocationChange(d);ATB.Events.handleBrowserLoadedNewPage(d)}return},onStateChange:function(){return 0},onProgressChange:function(){return 0},onStatusChange:function(){return 0},onSecurityChange:function(){return 0}};this.init()};ATB_Events.prototype={init:function(){ATB.Logger.info("Start *Events* Init...");ATB.Core.calculateImportantTbAttrs();ATB.Logger.info("Registering toolbar events...");ATB.Logger.info("Registering window event: resize");window.addEventListener("resize",this.handleResizeEvent,false);window.addEventListener("click",this.onOverflowMenuClick,false);window.addEventListener("focus",this.handleFocusEvent,false);window.addEventListener("mouseup",this.handleMouseUpEvent,true);var a=document.getElementById("urlbar");if(a){a.addEventListener("change",this.handleUrlBarChange,false)}ATB.Logger.info("Registering asktb-splitter event: mouseup");document.getElementById("asktb-splitter").addEventListener("mouseup",this.handleResizeEvent,false);ATB.Logger.info("Registration of events complete.");ATB.Logger.debug("Calling handleTbButtonAreaNarrowing() for setting the initial button positions..");ATB.Core.updateAttributesForTbResize();this.handleTbButtonAreaNarrowing(ATB.Utils.getAvailableBrowserWidth());gBrowser.addProgressListener(this.progressListener,Components.interfaces.nsIWebProgress.NOTIFY_STATE_DOCUMENT);if(document.getElementById("asktb").collapsed){this._attachCollapsedToolbarListeners()}ATB.Logger.info("End *Events* Init...")},unload:function(a){ATB.Logger.info("Unregistering toolbar events...");gBrowser.removeProgressListener(this.progressListener);ATB.Logger.info("Unregistration of events complete.")},handleLocationChange:function(a){ATB.Observer.publish(ATB.Observer.Events.LOCATION_CHANGED,a)},onSearchBoxValueChange:function(b,c){if(document.getElementById("asktb-btn-highlighter")){ATB.Core.resetHighlight();var a=document.getElementById("asktb-btn-highlighter");if(ATB.Utils.trim(c.value).length>0){ATB.Logger.debug("searchBoxValueChange: ",c.value);a.image="chrome://asktoolbar/skin/highlighter_on.png"}else{a.image="chrome://asktoolbar/skin/highlighter_off.png"}}},onSearchHistoryButtonClick:function(a){ATB.Logger.info("Search history dropmarker clicked");if(ATB.Prefs.saveSearches()){ATB.Logger.info("Opening search history popup if sh exists");ATB.Suggestions.displaySearchHistoryMenu()}else{ATB.Logger.info("Search history is disabled in options")}},onSearchBoxInput:function(a,b){if(ATB.Prefs.isSSEnabled()){if(ATB.Suggestions.ssTriggerDelayTimer){window.clearTimeout(ATB.Suggestions.ssTriggerDelayTimer)}ATB.Suggestions.ssTriggerDelayTimer=window.setTimeout("ATB.Suggestions.triggerSSApiCall();",ATB.Suggestions.ssTriggerDelay)}ATB.Events.onSearchBoxValueChange(a,b)},onSearchBoxKeyDown:function(a){if(ATB.Prefs.isSSEnabled()){ATB.Suggestions.handleSearchBoxKeyDown(a)}else{if(a.keyCode==a.DOM_VK_RETURN){ATB.Core.defaultSearchAction(a)}}return},onOverflowMenuClick:function(a){if(a.target.parentNode.id=="asktb-overflowmenu"&&!a.target.hasAttribute("widget-url")){ATB.Widgets.closeWidgetIfOpen()}},handleFocusEvent:function(a){if(ATB.Widgets.getWidgetLabelChanged()){ATB.Logger.debug("Processing toolbar buttons since widget labels have since changed.");ATB.Widgets.setWidgetLabelChanged(false);ATB.Events.handleButtonStateChanges(a)}else{}},handleButtonStateChanges:function(a){ATB.Logger.info("handleButtonStateChanges() called.");ATB.Events.handleTbButtonAreaNarrowing(ATB.Utils.getAvailableBrowserWidth());ATB.Events.handleTbButtonAreaWidening(ATB.Utils.getAvailableBrowserWidth());ATB.Logger.info("handleButtonStateChanges() processing complete.")},handleUrlBarChange:function(d){var b=document.getElementById("urlbar");if(b&&b.value){var g=document.getElementById("urlbar").value;if(g.indexOf(" ")==-1&&g.indexOf(".")!=-1){ATB.Logger.info("handleUrlBarChange: Received probableUri: ",g);if(g.indexOf("://")==-1){g="http://"+g;ATB.Logger.debug("handleUrlBarChange: Appended http:// to probableUri: ",g)}if(g.indexOf("http")==0){try{var c=Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService);var f=c.newURI(g,null,null);ATB.Logger.debug("handleUrlBarChange: Constructed nsiUri instance: ",f);if(f&&f.host){var e=f.host;ATB.Logger.info("handleUrlBarChange: Resolving domain: ",e);ATB.Net.resolveDomain(e,true)}else{ATB.Logger.warn("handleUrlBarChange: Could not detect from nsiUriInstance: ",f)}}catch(a){ATB.Logger.error("handleUrlBarChange: Error constructing nsiUriInstance from probableUri: ",g)}}else{ATB.Logger.info("handleUrlBarChange: uri is not a valid http uri - hence dns resolve skipped - ",g)}}else{ATB.Logger.debug("handleUrlBarChange: Domain resolve skipped because it either contains a space or does not contain a period: ",e)}}},handleResizeEvent:function(c){var e=ATB.Utils.getAvailableBrowserWidth();var a=ATB.Core.getSearchBoxWidth();var b=ATB.Core.getLastKnownBrowserInnerWidth();var d=ATB.Core.getLastKnownSearchBoxWidth();if(b!=e){ATB.Events.setSearchboxMaxWidth();if(e<b){ATB.Events.handleTbButtonAreaNarrowing(e)}else{if(e>b){ATB.Events.handleTbButtonAreaWidening(e)}}ATB.Core.updateTbWidthAttrs(e,a)}else{if(a!=d){if(a>d){ATB.Events.handleTbButtonAreaNarrowing(e)}else{if(a<d){ATB.Events.handleTbButtonAreaWidening(e)}}ATB.Core.updateTbWidthAttrs(e,a)}}return},overflowPopupActivated:function(){ATB.Logger.debug("Chevron: Showing button overflow popup...");var a=ATB.Core.getOverflowMenuContents();for(var b=0;b<a.length;b++){if(a[b].shouldBeActivated&&!a[b].isActive){ATB.Logger.debug("Chevron showing. ACTIVATING: ",a[b].getAttribute("id"));a[b].activateContent()}else{if(a[b].shouldBeActivated){ATB.Logger.debug("Chevron showing. FYI this item is already active: ",a[b].getAttribute("id"))}else{}}}},handleTbButtonAreaNarrowing:function(b){if(b>0){var j=ATB.Core.getActiveTbButtons();if(j&&j.length>0){var k=document.getElementById("asktb-overflowbtn");for(var d=j.length-1;d>=0;--d){var f=j[d];var h=f.getAttribute("id");var a=ATB.Core.getWidthNeededForToolbarButton(f);if(a>b){var c=f.cloneNode(true);ATB.Core.addButtonToOverflowMenu(c);if(f.isActive){f.deactivateContent()}try{if(c.hasNativeButton){c.showNativeButton()}}catch(g){ATB.Logger.error("Toolbar button "+h+" cloning failed: "+g)}if(c.getAttribute("rendering-enabled")=="true"){if(c.getAttribute("class")==ATB.Constants.BTN_TYPE_CLASS_DYNAMIC_TICKER){c.tick(false,true)}}ATB.Core.removeButtonFromToolbar(f)}else{}}}this.showHideOverflowMenuAsNeeded()}else{ATB.Logger.debug("handleTbButtonAreaNarrowing skipped because browserWidthAvailable is 0 (probably FF is in background or out of focus).")}return},handleTbButtonAreaWidening:function(g){if(g>0){if(!ATB.Core.isOverflowMenuEmpty()){var f=ATB.Core.getOverflowMenuContents();for(var b=0;b<f.length;b++){if(f[b]&&typeof(f[b])!="undefined"&&Node.ELEMENT_NODE==f[b].nodeType){var c=f[b].cloneNode(true);ATB.Core.addButtonToToolbar(c);if(c.shouldBeActivated&&!c.isActive){ATB.Logger.debug("handleTbButtonAreaWidening: ACTIVATING clone: ",c.getAttribute("id"));c.activateContent()}else{if(c.shouldBeActivated){ATB.Logger.debug("handleTbButtonAreaWidening: FYI this cloned item is already active: ",c.getAttribute("id"))}else{}}var a=ATB.Core.getWidthNeededForToolbarButton(c);if(a>ATB.Utils.getAvailableBrowserWidth()){if(c.isActive){c.deactivateContent()}ATB.Core.removeButtonFromToolbar(c);break}else{ATB.Core.removeButtonFromOverflowMenu(f[b]);try{if(ATB.Net.isNetworkAvailableForContent()&&c.showBrowser){c.showBrowser(true)}else{if(c.hasNativeButton){c.showNativeButton()}}}catch(d){ATB.Logger.error("Toolbar button "+buttonId+" cloning failed: "+d)}if(c.getAttribute("rendering-enabled")=="true"){if(c.getAttribute("class")==ATB.Constants.BTN_TYPE_CLASS_DYNAMIC_TICKER){c.setTickerItems(ATB.Cache.getValue(c.getAttribute("id")));c.tick(true,true)}}}}else{ATB.Logger.error('Undefined button "',f[b],'" found in the overflow menu. Total number of items in the menu: ',f.length)}}}else{ATB.Logger.debug("No buttons found in the overflow menu.")}this.showHideOverflowMenuAsNeeded()}else{ATB.Logger.debug("handleTbButtonAreaNarrowing skipped because browserWidthAvailable is 0 (probably FF is in background or out of focus).")}return},setSearchboxMaxWidth:function(){var a=130;if((ATB.Utils.getAvailableBrowserWidth()-a)>100){document.getElementById("asktb-searchbox-container").setAttribute("maxwidth",ATB.Utils.getAvailableBrowserWidth()-a)}},showHideOverflowMenuAsNeeded:function(a){var b=document.getElementById("asktb-overflowbtn");if(ATB.Core.isOverflowMenuEmpty()){b.collapsed=true}else{b.collapsed=false}},handleMouseUpEvent:function(a){if(ATB.Prefs.getBoolPref(ATB.Constants.ATB_AUTO_FILL_TH_ENABLED)){ATB.Core.autoFillSBOnTextHighLight(a)}},handleBrowserLoadedNewPage:function(a){if(ATB.Prefs.getBoolPref(ATB.Constants.ATB_AUTO_FILL_CQ_ENABLED)){if(a.asciiSpec){ATB.Core.autoFillSBWithCompetitorQuery(a.asciiSpec)}}},_attachCollapsedToolbarListeners:function(){ATB.Logger.info("Entering _attachCollapsedToolbarListeners");var c,b,a;a=["viewToolbarsMenu","toolbar-context-menu","appmenu_customizeMenu"];for(b=0;b<a.length;b++){c=document.getElementById(a[b]);c.addEventListener("command",this.handleToolbarUncollapsed,false)}ATB.Logger.info("Exiting _attachCollapsedToolbarListeners")},handleToolbarUncollapsed:function(b){ATB.Logger.info("Entering handleToolbarUncollapsed");var e,a,c,d;if(document.getElementById("asktb").collapsed){ATB.Logger.info("Exiting handleToolbarUncollapsed: toolbar is still collapsed");return}a=["viewToolbarsMenu","toolbar-context-menu","appmenu_customizeMenu"];for(d=0;d<a.length;d++){e=document.getElementById(a[d]);e.removeEventListener("command",ATB.Events.handleToolbarUncollapsed,false)}c=document.getElementById("asktb").getElementsByTagName("toolbaritem");for(d=0;d<c.length;d++){e=c[d];if((typeof e.shouldBeActivated!="undefined")&&(e.shouldBeActivated)){if(typeof e.loadContent=="function"){ATB.Logger.info("Calling loadContent on "+e.id);e.loadContent()}else{ATB.Logger.info("No loadContent method: "+e.id)}}}}};