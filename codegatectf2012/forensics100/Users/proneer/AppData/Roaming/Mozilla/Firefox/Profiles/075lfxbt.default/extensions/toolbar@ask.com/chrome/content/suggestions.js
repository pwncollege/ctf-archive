/*
 * Copyright (C) 2008-2010 APN, LLC. All rights reserved
 * References to external sources embedded in the code.
 * 
 * Author: Tanmay.Shrivastava
 * Description: Toolbar search suggestions/ search history module.
 */
var ATB_Suggestions=function(){this.ssUrl=null;this.ssPopup=null;this.shPopup=null;this.ssListbox=null;this.shListbox=null;this.ssTriggerLength=0;this.searchBox=null;this.ssMaxCount=0;this.ssTriggerDelayTimer=null;this.ssTriggerDelay=0;this.utf8Converter=null;this.searchAlreadyExecutedFlag=false;this.browserVersion=null;this.init()};ATB_Suggestions.prototype={init:function(){ATB.Logger.info("Start *Suggestions* Init...");try{this.browserVersion=ATB.Utils.getBrowserVersion();this.utf8Converter=Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);this.searchBox=document.getElementById("asktb-searchbox");this.ssUrl=ATB.Utils.getLocalizedStringForKey("$SearchSuggestions$",ATB.Utils.getDocObjHostingATB());this.ssPopup=document.getElementById("asktb-suggestions-popup");this.shPopup=document.getElementById("asktb-searchhistory-popup");this.ssListbox=document.getElementById("asktb-suggestions-popup-ss-listbox");this.shListbox=document.getElementById("asktb-suggestions-popup-sh-listbox");this.ssTriggerLength=this.ssPopup.hasAttribute("ssTriggerLength")?this.ssPopup.getAttribute("ssTriggerLength"):1;this.ssMaxCount=this.ssPopup.hasAttribute("ssMaxCount")?this.ssPopup.getAttribute("ssMaxCount"):10;this.shMaxCount=this.ssPopup.hasAttribute("shMaxCount")?this.ssPopup.getAttribute("shMaxCount"):3;this.ssEnabled=this.searchBox.hasAttribute("ssEnabled")?this.searchBox.getAttribute("ssEnabled"):"true";this.ssTriggerDelay=this.ssPopup.hasAttribute("ssTriggerDelay")?parseInt(this.ssPopup.getAttribute("ssTriggerDelay")):200;if(this.ssEnabled=="true"&&!(this.browserVersion<3)){ATB.Prefs.setSSEnabled(true);for(var d=0;d<this.ssMaxCount;d++){var a=document.createElement("hbox");a.setAttribute("class","asktb-ssMenuitem");a.setAttribute("sb-text","");a.setAttribute("rem-text","");a.setAttribute("hidden","true");a.setAttribute("index-no",d);if(d==0){a.setAttribute("header",ATB.Utils.getLocalizedStringForKey("Suggestions"))}this.ssListbox.appendChild(a)}for(d=0;d<this.shMaxCount;d++){var c=document.createElement("hbox");c.setAttribute("class","asktb-ssMenuitem");c.setAttribute("sb-text","");c.setAttribute("rem-text","");c.setAttribute("hidden","true");c.setAttribute("index-no",d);if(d==0){c.setAttribute("header",ATB.Utils.getLocalizedStringForKey("History"))}this.shListbox.appendChild(c)}}else{ATB.Prefs.setSSEnabled(false)}}catch(b){ATB.Logger.warn("Error: ",b," while initializing Search Suggestions params, disabling it. Probably FF version is not supported.");ATB.Prefs.setSSEnabled(false)}ATB.Logger.info("End *Suggestions* Init...");return},triggerSSApiCall:function(){var b=ATB.Suggestions.searchBox.value;ATB.Suggestions.ssPopup.userInputValue=b;if(b.length>=ATB.Suggestions.ssTriggerLength){var a=ATB.Suggestions.ssUrl+encodeURIComponent(b);ATB.Logger.info("Triggering call to SS API.....for value :",b);ATB.Net.getBinaryResponseTextFromUrlAsynchronously(a,ATB.Suggestions.processResponseFromSSApi,b.length)}else{ATB.Suggestions.ssPopup.hidePopup();ATB.Suggestions.searchBox.focus()}return},filterDuplicateSSEntries:function(b){var c=[];for(var a=0;a<b.length;a++){if(!ATB.Core.queryExistsInSearchHistory(b[a])){c.push(b[a])}}return c},getSearchHistoryMatches:function(b){var d=[];if(ATB.Prefs.saveSearches()){var c=ATB.Core.getRecentSearchHistoryAsArray();for(var a=c.length-1;a>=0;a--){if(c[a].indexOf(b)==0){d.push(c[a]);if(d.length==ATB.Suggestions.shMaxCount){break}}}}return d},processResponseFromSSApi:function(c,a,n){var l=ATB.Suggestions.searchBox.value;ATB.Logger.info("Processing response from SS API....for value :",l);var o=ATB.Utils.jsonEval(a);ATB.Logger.debug("ss Array :",o," got from SS API for value :",l);var e=ATB.Suggestions.filterDuplicateSSEntries(o[1]);ATB.Logger.debug("ss Array after filtering search history entries :",e);var b=ATB.Suggestions.getSearchHistoryMatches(l);ATB.Logger.debug("Search history matches for value: ",l,"after filtering search history entries :",b);var f=ATB.Suggestions.ssListbox.getElementsByTagName("hbox");var d=ATB.Suggestions.shListbox.getElementsByTagName("hbox");var h=0,g=0;if((e!=null&&e.length>0)||(b.length>0)){for(h;h<ATB.Suggestions.shMaxCount;h++){if(h<b.length){d[h].setAttribute("sb-text",b[h].substring(0,n));d[h].setAttribute("rem-text",b[h].substring(n));d[h].setAttribute("hidden","false")}else{d[h].setAttribute("hidden","true")}}for(g;g<ATB.Suggestions.ssMaxCount;g++){if(g<e.length){var k=ATB.Suggestions.utf8Converter.convertURISpecToUTF8(e[g],"UTF-8");var p=(l.replace(/\s+/g," ")).replace(/^\s/,"").length;f[g].setAttribute("sb-text",k.substring(0,p));f[g].setAttribute("rem-text",k.substring(p));f[g].setAttribute("hidden","false")}else{f[g].setAttribute("hidden","true")}}if((e!=null&&e.length>0)&&(b.length>0)){document.getElementById("asktb-suggestions-popup-separator1").setAttribute("hidden","false")}else{document.getElementById("asktb-suggestions-popup-separator1").setAttribute("hidden","true")}if(b.length>0){document.getElementById("asktb-suggestions-popup-ch").setAttribute("hidden","false")}else{document.getElementById("asktb-suggestions-popup-ch").setAttribute("hidden","true")}ATB.Suggestions.shPopup.closePopup();var m=document.getElementById("asktb-searchbox").boxObject.width+document.getElementById("asktb-searchbtn").boxObject.width+((this.browserVersion>3)?4:0);ATB.Suggestions.ssPopup.sizeTo(m,0);if(!ATB.Suggestions.searchAlreadyExecutedFlag){ATB.Suggestions.ssPopup.openPopup(document.getElementById("asktb-btn-service-provider"),"end_before",0,23,false,false)}}else{ATB.Suggestions.ssPopup.closePopup()}ATB.Suggestions.searchBox.focus();ATB.Suggestions.ssTriggerDelayTimer=null;ATB.Suggestions.searchAlreadyExecutedFlag=false},closeSuggestionsPopup:function(){try{if(document.getElementById("asktb-suggestions-popup").state=="open"||document.getElementById("asktb-searchhistory-popup").state=="open"){document.getElementById("asktb-suggestions-popup").closePopup();document.getElementById("asktb-searchhistory-popup").closePopup()}}catch(a){ATB.Logger.warn("Error occured while closeSuggestionsPopup() : ",a)}},handleSearchBoxKeyDown:function(b){try{var a=(this.shPopup&&this.shPopup.isPopupOpen)?this.shPopup:this.ssPopup;this.searchAlreadyExecutedFlag=false;if(b.altKey&&((b.keyCode>=65&&b.keyCode<=90)||(b.keyCode>=48&&b.keyCode<=57))){b.stopPropagation();b.preventDefault();return}if(b.keyCode==b.DOM_VK_RETURN||b.keyCode==b.DOM_VK_ENTER){if(this.ssTriggerDelayTimer){window.clearTimeout(this.ssTriggerDelayTimer)}this.searchAlreadyExecutedFlag=true;ATB.Core.defaultSearchAction(b);a.closePopup();b.stopPropagation();document.getElementById("asktb-searchbtn").focus();return}if(b.keyCode==b.DOM_VK_ESCAPE){this.searchBox.value=a.userInputValue;return}if(!(b.keyCode==b.DOM_VK_UP||b.keyCode==b.DOM_VK_DOWN||b.keyCode==b.DOM_VK_TAB||b.keyCode==b.DOM_VK_LEFT||b.keyCode==b.DOM_VK_RIGHT||b.keyCode==b.DOM_VK_ESCAPE||b.keyCode==b.DOM_VK_RETURN)){return}if(b.keyCode==b.DOM_VK_LEFT||b.keyCode==b.DOM_VK_RIGHT||b.keyCode==b.DOM_VK_RETURN){a.closePopup();return}if(b.keyCode==b.DOM_VK_UP||b.keyCode==b.DOM_VK_DOWN){this.adjustSuggestionsSelectedIndex(b,a);return}}catch(c){ATB.Logger.debug("Error while search box key down processing : ",c);b.stopPropagation();return}},adjustSuggestionsSelectedIndex:function(c,b){var a=(c.keyCode==c.DOM_VK_UP);var d=(c.keyCode==c.DOM_VK_DOWN);if(b.isPopupOpen){if(d){b.selectedIndex++}else{if(a){b.selectedIndex--}}}else{if(d){this.ssPopup.selectedIndex=-1;this.triggerSSApiCall();this.searchBox.focus()}}if(b.selectedIndex<0){this.searchBox.value=b.userInputValue}c.stopPropagation();return},displaySearchHistoryMenu:function(){ATB.Logger.debug("Clearing all the search history items from the MENU(not memory)");this.clearSearchHistoryMenu();this.populateSearchHistoryMenuFromCache();var a=document.getElementById("asktb-searchhistory-popup-sh-listbox");if(a.childNodes.length>0){this.shPopup.userInputValue=this.searchBox.value;this.shPopup.openPopup(this.searchBox,"after_start",0,0,false,false);this.searchBox.focus()}},clearSearchHistoryMenu:function(){var a=document.getElementById("asktb-searchhistory-popup-sh-listbox");while(a.hasChildNodes()){a.removeChild(a.lastChild)}},populateSearchHistoryMenuFromCache:function(){var c=ATB.Core.getRecentSearchHistoryAsArray();ATB.Logger.debug("Populating search history items:",c,"in the search history MENU");for(var b=c.length-1;b>=0;b--){var a=document.createElement("hbox");a.setAttribute("class","asktb-ssMenuitem");a.setAttribute("sb-text",c[b]);a.setAttribute("rem-text","");a.setAttribute("hidden","false");a.setAttribute("index-no",c.length-1-b);document.getElementById("asktb-searchhistory-popup-sh-listbox").appendChild(a)}}};